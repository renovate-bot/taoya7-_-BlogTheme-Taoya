(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{726:function(t,s,a){"use strict";a.r(s);var e=a(6),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h3",{attrs:{id:"简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),a("p",[t._v("Celery是一个简单、灵活且可靠的，处理大量消息的"),a("u",[t._v("分布式系统")])]),t._v(" "),a("p",[t._v("专注于实时处理的异步任务队列。")]),t._v(" "),a("p",[t._v("Celery通过将功能的一部分作为延迟任务运行在与其他任务相同的服务器上或在其他服务器上，从而降低了性能负载。")]),t._v(" "),a("blockquote",[a("p",[t._v("Celery架构由三部分组成，消息中间件"),a("code",[t._v("message broker")]),t._v(" . 任务执行单元"),a("code",[t._v("worker")]),t._v("  . 任务结果存储"),a("code",[t._v("task result store")]),t._v(" 组成")]),t._v(" "),a("p",[a("strong",[t._v("消息中间件")])]),t._v(" "),a("p",[t._v("Celery本身不提供消息服务，但是可以方便的和第三方提供的消息中间件集成。包括，RabbitMQ, Redis等等")]),t._v(" "),a("p",[a("strong",[t._v("任务执行单元")])]),t._v(" "),a("p",[t._v("Worker是Celery提供的任务执行的单元，worker并发的运行在分布式的系统节点中")]),t._v(" "),a("p",[a("strong",[t._v("任务结果存储")])]),t._v(" "),a("p",[t._v("Task result store用来存储Worker执行的任务的结果，Celery支持以不同方式存储任务的结果，包括AMQP, redis等")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://alicdn.itaolaity.com/img/20200617095937.png",alt:""}})]),t._v(" "),a("blockquote",[a("p",[t._v("celery是一个强大的 分布式任务队列的异步处理框架，它可以让任务的执行完全脱离主程序，甚至可以被分配到其他主机上运行。我们通常使用它来实现异步任务"),a("code",[t._v("async task")]),t._v("和定时任务"),a("code",[t._v("crontab")])]),t._v(" "),a("p",[a("strong",[t._v("异步任务")]),t._v("：将耗时操作任务提交给Celery去异步执行，比如发送短信/邮件、消息推送、音视频处理等等")]),t._v(" "),a("p",[t._v("**定时任务：**定时执行某件事情，比如每天数据统计")])]),t._v(" "),a("h3",{attrs:{id:"简单使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单使用"}},[t._v("#")]),t._v(" 简单使用")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("使用Redis作为Broker")])]),t._v(" "),a("li",[a("p",[t._v("创建一个文件夹"),a("code",[t._v("tasks.py")])])])]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" celery "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Celery\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" time  \n\n\nbroker "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'redis://127.0.0.1:6379/0'")]),t._v("\nbackend "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'redis://127.0.0.1:6379/1'")]),t._v("\n\napp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Celery"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tasks'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" broker"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("broker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" backend"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("backend"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("task")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("y"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"添加操作...{}+{}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("y"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\ttime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sleep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"添加操作已完成..."')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("str")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("y"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" x"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("y                       \n")])])]),a("p",[t._v("然后启动")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("celery -A tasks worker --loglevel"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("info -P gevent\n")])])]),a("p",[a("img",{attrs:{src:"http://alicdn.itaolaity.com/img/20200616114915.png",alt:""}})]),t._v(" "),a("blockquote",[a("p",[t._v("如何发送任务？")])]),t._v(" "),a("p",[t._v("打开终端")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@Taoya ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# python3")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" from tasks "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" add.delay"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1,2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("AsyncResult: 04d02448-e3e1-482c-ad3f-eaa09be82b6"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("5")]),t._v(">")]),t._v("\n")])])]),a("p",[t._v("同时看到")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://alicdn.itaolaity.com/img/20200617104326.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Redis 查看任务结果")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"status"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SUCCESS"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"result"')]),t._v(":3,\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traceback"')]),t._v(":null,\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"children"')]),t._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"date_done"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2020-06-17T02:42:37.977013"')]),t._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"task_id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"04d02448-e3e1-482c-ad3f-eaa09be82b65"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"http://alicdn.itaolaity.com/img/20200617104420.png",alt:""}})]),t._v(" "),a("hr"),t._v(" "),a("h3",{attrs:{id:"celery的核心模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#celery的核心模块"}},[t._v("#")]),t._v(" Celery的核心模块")]),t._v(" "),a("p",[a("code",[t._v("task")])]),t._v(" "),a("ul",[a("li",[t._v("异步任务")]),t._v(" "),a("li",[t._v("定时任务")])]),t._v(" "),a("p",[a("code",[t._v("broker")]),t._v(" 中间人")]),t._v(" "),a("p",[t._v("接收生产者发来的消息即Task，将任务存入队列。任务的消费者是Worker")]),t._v(" "),a("blockquote",[a("p",[t._v("Celery本身不提供队列服务，推荐用Redis或RabbitMQ实现队列服务")])]),t._v(" "),a("p",[a("code",[t._v("Worker")])]),t._v(" "),a("p",[t._v("执行任务的单元，它实时监控消息队列，如果有任务就获取任务并执行它")]),t._v(" "),a("p",[a("code",[t._v("Beat")])]),t._v(" "),a("p",[t._v("定时任务调度器，根据配置定时将任务发送给Broker")]),t._v(" "),a("p",[a("code",[t._v("Backend")])]),t._v(" "),a("p",[t._v("用于存储任务的执行结果")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://alicdn.itaolaity.com/img/20200616122652.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"监控celery"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#监控celery"}},[t._v("#")]),t._v(" 监控Celery")]),t._v(" "),a("p",[t._v("有一个方便的基于Web的工具，称为"),a("a",{attrs:{href:"http://flower.readthedocs.io/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Flower"),a("OutboundLink")],1),t._v("，可用于监视和管理芹菜群集。Flower提供了任务进度和历史记录的详细统计信息，还显示了其他任务详细信息，例如传递的参数，开始时间，运行时等。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" flower\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ celery -A tasks worker -l info -P gevent\n")])])]),a("p",[t._v("再打开一个终端，接着启动flower")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("λ celery -A tasks flower\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("I "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200617")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(":58:06 command:136"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Visit me at http://localhost:5555\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("I "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200617")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(":58:06 command:141"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Broker: redis://127.0.0.1:6379/0\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("I "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200617")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(":58:06 command:144"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Registered tasks:\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.accumulate'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.backend_cleanup'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.chain'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.chord'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.chord_unlock'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.chunks'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.group'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.map'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'celery.starmap'")]),t._v(",\n     "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tasks.add'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("I "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200617")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(":58:06 mixins:229"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Connected to redis://127.0.0.1:6379/0\n")])])]),a("p",[a("img",{attrs:{src:"http://alicdn.itaolaity.com/img/20200617110656.png",alt:""}})]),t._v(" "),a("ul",[a("li",[t._v("任务列表")])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://alicdn.itaolaity.com/img/20200617110709.png",alt:""}})]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Broker")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"http://alicdn.itaolaity.com/img/20200617111439.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"其他"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[t._v("#")]),t._v(" 其他")]),t._v(" "),a("p",[t._v("可以使用以下命令删除所有待处理任务")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ celery -A tasks purge\n")])])]),a("h3",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),a("h4",{attrs:{id:"解决windows调试错误"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决windows调试错误"}},[t._v("#")]),t._v(" 解决Windows调试错误")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" eventlet\n\ncelery -A "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("module"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" worker -l info -P eventlet\n")])])]),a("p",[t._v("如果还是报错请尝试"),a("code",[t._v("gevent")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" gevent\ncelery -A "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("module"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" worker -l info -P gevent\n")])])]),a("h3",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/mher/flower",target:"_blank",rel:"noopener noreferrer"}},[t._v("flower github"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=r.exports}}]);