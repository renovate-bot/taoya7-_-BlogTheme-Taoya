<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>整合QQ登录、入库 | Taoya</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC|Open+Sans|Poppins|Source+Sans+Pro|Ubuntu&amp;display=swap">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
    <link rel="alternate" type="application/rss+xml" href="https://itaolaity.com/rss.xml" title="Taoya RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://itaolaity.com/feed.atom" title="Taoya Atom Feed">
    <link rel="alternate" type="application/json" href="https://itaolaity.com/feed.json" title="Taoya JSON Feed">
    <meta name="description" content="多言数穷，不如守中">
    <meta property="article:published_time" content="2020-04-27T16:00:00.000Z">
    <meta property="og:site_name" content="Taoya">
    <meta property="og:title" content="整合QQ登录、入库">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/_posts/2020-4-28-QQ%E7%99%BB%E5%BD%95.html">
    <meta name="twitter:title" content="整合QQ登录、入库">
    <meta name="twitter:url" content="/_posts/2020-4-28-QQ%E7%99%BB%E5%BD%95.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Django">
    <meta property="article:tag" content="Django">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.14cf5c8f.css" as="style"><link rel="preload" href="/assets/js/app.142c00a5.js" as="script"><link rel="preload" href="/assets/js/7.a35a4700.js" as="script"><link rel="preload" href="/assets/js/35.219991cc.js" as="script"><link rel="prefetch" href="/assets/js/1.efc344b4.js"><link rel="prefetch" href="/assets/js/10.5b403478.js"><link rel="prefetch" href="/assets/js/11.761de324.js"><link rel="prefetch" href="/assets/js/12.004a0cd1.js"><link rel="prefetch" href="/assets/js/13.1aa4eda6.js"><link rel="prefetch" href="/assets/js/14.1f76b60b.js"><link rel="prefetch" href="/assets/js/15.1e143b81.js"><link rel="prefetch" href="/assets/js/16.301fb663.js"><link rel="prefetch" href="/assets/js/17.f0f59a9f.js"><link rel="prefetch" href="/assets/js/18.504ac4aa.js"><link rel="prefetch" href="/assets/js/19.882b50d0.js"><link rel="prefetch" href="/assets/js/20.14fbc039.js"><link rel="prefetch" href="/assets/js/21.4316a61c.js"><link rel="prefetch" href="/assets/js/22.c72b3b10.js"><link rel="prefetch" href="/assets/js/23.22b802ed.js"><link rel="prefetch" href="/assets/js/24.8aa7ebec.js"><link rel="prefetch" href="/assets/js/25.0a05a7cf.js"><link rel="prefetch" href="/assets/js/26.1ff9eaf1.js"><link rel="prefetch" href="/assets/js/27.5338523f.js"><link rel="prefetch" href="/assets/js/28.37c17d59.js"><link rel="prefetch" href="/assets/js/29.3c1b9282.js"><link rel="prefetch" href="/assets/js/30.dbd96a20.js"><link rel="prefetch" href="/assets/js/31.8624522a.js"><link rel="prefetch" href="/assets/js/32.2067be4e.js"><link rel="prefetch" href="/assets/js/33.f740f837.js"><link rel="prefetch" href="/assets/js/34.4a469f8b.js"><link rel="prefetch" href="/assets/js/36.70d84c73.js"><link rel="prefetch" href="/assets/js/37.350615c2.js"><link rel="prefetch" href="/assets/js/38.4eb52217.js"><link rel="prefetch" href="/assets/js/39.5a941860.js"><link rel="prefetch" href="/assets/js/4.f5034f51.js"><link rel="prefetch" href="/assets/js/40.ec2d91f4.js"><link rel="prefetch" href="/assets/js/41.2ae8f78b.js"><link rel="prefetch" href="/assets/js/5.3df00ca3.js"><link rel="prefetch" href="/assets/js/6.4e44cfcb.js"><link rel="prefetch" href="/assets/js/8.df3ba7e2.js"><link rel="prefetch" href="/assets/js/9.ceb081a3.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.3213ad10.js">
    <link rel="stylesheet" href="/assets/css/0.styles.14cf5c8f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div author="Taolin" id="taolin"><header class="tl-header"><div class="wrap"><div class="tl-logo"><h1><a href="/" class="router-link-active"><svg width="360" height="360" viewBox="0 0 360 360" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><rect width="360" height="360" fill="black"></rect> <path d="M314 217.328C314 222.203 312.453 228.719 309.359 236.875C301.391 258.25 286.109 274.703 263.516 286.234C243.734 296.359 221.469 301.422 196.719 301.422C163.25 301.422 137.984 292.516 120.922 274.703C105.453 258.578 97.7188 236.5 97.7188 208.469C97.7188 186.062 103.016 162.484 113.609 137.734C121.016 120.672 128.562 107.266 136.25 97.5156C109.438 100.516 85.4375 110.406 64.25 127.188C63.125 128.406 62.375 128.312 62 126.906C60.0312 114.344 57.4531 93.9062 54.2656 65.5938C54.3594 65.0312 54.9219 64.5625 55.9531 64.1875C130.203 70.4688 207.5 73.6094 287.844 73.6094C289.438 73.6094 290 74.5938 289.531 76.5625C279.688 115.281 273.641 146.266 271.391 169.516C264.641 168.484 255.922 166.75 245.234 164.312C240.172 162.625 237.641 160.047 237.641 156.578C237.641 154.703 238.344 150.531 239.75 144.062C241.25 137.5 242 132.625 242 129.438C242 124.844 240.547 121.609 237.641 119.734C220.859 108.672 207.547 102.438 197.703 101.031C180.734 133 172.25 168.391 172.25 207.203C172.25 228.766 175.484 246.484 181.953 260.359C188.891 275.453 198.453 283 210.641 283C219.734 283 229.719 279.391 240.594 272.172C250.719 265.328 255.781 259.797 255.781 255.578C255.781 253.891 255.219 253.047 254.094 253.047C239.938 250.891 227.797 246.25 217.672 239.125C205.672 230.781 199.672 220.656 199.672 208.75C199.672 202.375 203.891 197.125 212.328 193C220.859 188.875 232.391 186.812 246.922 186.812C253.391 186.812 260.984 187.375 269.703 188.5C299.234 192.438 314 202.047 314 217.328Z" fill="white"></path></g> <defs><clipPath id="clip0"><rect width="360" height="360" fill="white"></rect></clipPath></defs></svg></a></h1> <span>Taoya</span></div> <nav class="tl-menu"><ul class="tl-menu-list"><li class="tl-menu-item"><a href="/blog/">技术</a></li><li class="tl-menu-item"><a href="/about/">关于</a></li></ul> <div class="tl-menu-trigger"><button class="menu-btn"><svg viewBox="0 0 64 48"><path d="M19,15 L45,15 C70,15 58,-2 49.0177126,7 L19,37"></path> <path d="M19,24 L45,24 C61.2371586,24 57,49 41,33 L32,24"></path> <path d="M45,33 L19,33 C-8,33 6,-2 22,14 L45,37"></path></svg></button></div> <div class="tl-hamburger"><div class="menu-secondary-background-color"></div> <div class="tl-menu-overlay"><div class="tl-f-nav-list"><div class="menu-background"></div> <div class="container"><div class="tl-f-nav-col"><h3 class="tl-f-nav-item"><a href="/blog"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       01
                                   </div> <div class="tl-menu-name">
                                       技术
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/about"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       02
                                   </div> <div class="tl-menu-name">
                                       关于
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3></div></div></div></div></div></nav></div></header> <div id="article-post" data-scroll=""><main class="container"><div class="back"><div class="icon-wrap"><svg aria-hidden="true" class="icon"><use xlink:href="#icon-fanhui"></use></svg></div></div> <header><h1 class="title">整合QQ登录、入库</h1> <div class="time"><span class="month">04</span> <span>/ <span>28</span></span></div></header> <article class="tl-article-container"><!----> <div class="content__default"><p>先看流程图</p> <p><img src="http://cdn.itaolaity.com/20200428225114.png" alt=""></p> <hr> <blockquote><p>准备工作</p> <p><a href="https://connect.qq.com/manage.html" target="_blank" rel="noopener noreferrer">QQ互联官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>appid</p> <p>appkey</p></blockquote> <p><img src="http://cdn.itaolaity.com/20200428223024.png" alt=""></p> <h3 id="准备的url"><a href="#准备的url" class="header-anchor">#</a> 准备的URL</h3> <p>登录页面授权</p> <div class="language-shell extra-class"><pre class="language-shell"><code>https://graph.qq.com/oauth2.0/show
<span class="token assign-left variable">response_type</span><span class="token operator">=</span>code
<span class="token assign-left variable">client_id</span><span class="token operator">=</span>%s
<span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>%s
<span class="token assign-left variable">scope</span><span class="token operator">=</span>%s
</code></pre></div><p>获取TokenURL</p> <div class="language-shell extra-class"><pre class="language-shell"><code>https://graph.qq.com/oauth2.0/token
<span class="token assign-left variable">grant_type</span><span class="token operator">=</span>authorization_code
<span class="token assign-left variable">client_id</span><span class="token operator">=</span>%s
<span class="token assign-left variable">client_secret</span><span class="token operator">=</span>%s
<span class="token assign-left variable">code</span><span class="token operator">=</span>%s
<span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>%s
</code></pre></div><p>获得用户OpenID的URL</p> <div class="language-shell extra-class"><pre class="language-shell"><code>https://graph.qq.com/oauth2.0/me
<span class="token assign-left variable">access_token</span><span class="token operator">=</span>%s
</code></pre></div><p>获得用户信息的URL</p> <div class="language-shell extra-class"><pre class="language-shell"><code>https://graph.qq.com/user/get_user_info
<span class="token assign-left variable">access_token</span><span class="token operator">=</span>%s
<span class="token assign-left variable">oauth_consumer_key</span><span class="token operator">=</span>%s
<span class="token assign-left variable">openid</span><span class="token operator">=</span>%s
</code></pre></div><hr> <h3 id="数据库设计"><a href="#数据库设计" class="header-anchor">#</a> 数据库设计</h3> <ul><li>基本用户表</li> <li>社交登录表</li></ul> <p>用户表基本的不能再基本了，里面主要有两个字段，用户名和密码</p> <p>社交登录表主要是<code>openid</code>  因为 OpenID值是与QQ号一一对应</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 用户</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        db_table <span class="token operator">=</span> <span class="token string">'tl_user'</span> <span class="token comment"># 表名</span>
        verbose_name <span class="token operator">=</span> <span class="token string">'用户表'</span> <span class="token comment"># 表备注</span>
        verbose_name_plural <span class="token operator">=</span> verbose_name
 
<span class="token comment"># 社交</span>
<span class="token keyword">class</span> <span class="token class-name">SocialUser</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    open_id <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token comment"># 身份ID</span>
    app_type <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment"># 种类</span>
    status <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>     <span class="token comment"># 状态</span>
    nickname <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment"># 昵称</span>
    avatar <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>   <span class="token comment"># 头像</span>
    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 创建时间</span>

    user <span class="token operator">=</span> models<span class="token punctuation">.</span>OneToOneField<span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 包含用户</span>

    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        db_table <span class="token operator">=</span> <span class="token string">'tl_user_social'</span>
</code></pre></div><p><img src="http://cdn.itaolaity.com/20200428223455.png" alt=""></p> <h3 id="code"><a href="#code" class="header-anchor">#</a> Code</h3> <p>先来看看QQ登录官方给的步骤</p> <p><img src="http://cdn.itaolaity.com/20200428223109.png" alt=""></p> <hr> <p>创建一个<code>oauth_qq.py</code>工具类，主要的作用就是</p> <ol><li>获取QQ登录按钮链接</li> <li>获取AccessToken</li> <li>获取用户的OpenID</li> <li>获取用户信息</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlencode
<span class="token keyword">import</span>  requests
<span class="token keyword">import</span> json

<span class="token keyword">class</span> <span class="token class-name">OAuthQQ</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client_id<span class="token punctuation">,</span> client_key<span class="token punctuation">,</span> redirect_uri<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client_id
        self<span class="token punctuation">.</span>client_key <span class="token operator">=</span> client_key
        self<span class="token punctuation">.</span>redirect_uri <span class="token operator">=</span> redirect_uri

    <span class="token keyword">def</span> <span class="token function">get_auth_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        获取授权页面的网址
        '''</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'which'</span><span class="token punctuation">:</span> <span class="token string">'Login'</span><span class="token punctuation">,</span>
            <span class="token string">'display'</span><span class="token punctuation">:</span> <span class="token string">'pc'</span><span class="token punctuation">,</span>
            <span class="token string">'response_type'</span><span class="token punctuation">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
            <span class="token string">'client_id'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
            <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>redirect_uri<span class="token punctuation">,</span>
            <span class="token string">'scope'</span><span class="token punctuation">:</span> <span class="token string">'get_user_info'</span><span class="token punctuation">,</span>
            <span class="token string">'state'</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/oauth2.0/show?%s'</span><span class="token operator">%</span>urlencode<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
        <span class="token keyword">return</span> url
</code></pre></div><h4 id="放置qq登录按钮"><a href="#放置qq登录按钮" class="header-anchor">#</a> 放置QQ登录按钮</h4> <p>这里我们用视图来返回</p> <p>逻辑很简单访问index视图返回QQ登录跳转链接</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    oauth_qq <span class="token operator">=</span> OAuthQQ<span class="token punctuation">(</span>client_id<span class="token operator">=</span>QQ_APP_ID<span class="token punctuation">,</span> client_key<span class="token operator">=</span>QQ_KEY<span class="token punctuation">,</span>redirect_uri<span class="token operator">=</span>QQ_RECALL_URI<span class="token punctuation">)</span>
    url <span class="token operator">=</span> oauth_qq<span class="token punctuation">.</span>get_auth_url<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'qq.html'</span><span class="token punctuation">,</span> context<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'url'</span><span class="token punctuation">:</span>url<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-info&quot;</span>
    target<span class="token operator">=</span><span class="token string">&quot;_blank&quot;</span>
    href<span class="token operator">=</span><span class="token string">&quot;{{ url }}&quot;</span>
<span class="token operator">&gt;</span>QQ登录<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
</code></pre></div><p><img src="http://cdn.itaolaity.com/20200428223710.png" alt=""></p> <h4 id="路由地址"><a href="#路由地址" class="header-anchor">#</a> 路由地址</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
	url<span class="token punctuation">(</span><span class="token string">'qq'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 登录测试页</span>
    
    url<span class="token punctuation">(</span><span class="token string">r'^oauth/qq/login/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>qq_login<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'qq_login'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 处理QQ登录逻辑视图</span>
<span class="token punctuation">]</span>
</code></pre></div><h4 id="登录功能"><a href="#登录功能" class="header-anchor">#</a> 登录功能</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlencode
<span class="token keyword">import</span>  requests
<span class="token keyword">import</span> json

<span class="token keyword">class</span> <span class="token class-name">OAuthQQ</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client_id<span class="token punctuation">,</span> client_key<span class="token punctuation">,</span> redirect_uri<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client_id
        self<span class="token punctuation">.</span>client_key <span class="token operator">=</span> client_key
        self<span class="token punctuation">.</span>redirect_uri <span class="token operator">=</span> redirect_uri

    <span class="token keyword">def</span> <span class="token function">get_auth_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        获取授权页面的网址
        '''</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'which'</span><span class="token punctuation">:</span> <span class="token string">'Login'</span><span class="token punctuation">,</span>
            <span class="token string">'display'</span><span class="token punctuation">:</span> <span class="token string">'pc'</span><span class="token punctuation">,</span>
            <span class="token string">'response_type'</span><span class="token punctuation">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
            <span class="token string">'client_id'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
            <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>redirect_uri<span class="token punctuation">,</span>
            <span class="token string">'scope'</span><span class="token punctuation">:</span> <span class="token string">'get_user_info'</span><span class="token punctuation">,</span>
            <span class="token string">'state'</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/oauth2.0/show?%s'</span><span class="token operator">%</span>urlencode<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
        <span class="token keyword">return</span> url
</code></pre></div><p>这是上面的代码，接着往下写。 获取Access_Token</p> <p>我们可以在授权登录后他会跳转到我们指定的返回URL上。</p> <p>我们可以在处理Login的视图上来获取到Token</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_access_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    	根据Code获取access_token
    '''</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'grant_type'</span><span class="token punctuation">:</span> <span class="token string">'authorization_code'</span><span class="token punctuation">,</span>
        <span class="token string">'client_id'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
        <span class="token string">'client_secret'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_key<span class="token punctuation">,</span>
        <span class="token string">'code'</span><span class="token punctuation">:</span> code<span class="token punctuation">,</span>
        <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>redirect_uri
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/oauth2.0/token?%s'</span><span class="token operator">%</span>urlencode<span class="token punctuation">(</span>params<span class="token punctuation">)</span>

    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>text
    access_token <span class="token operator">=</span> response<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>access_token <span class="token operator">=</span> access_token
    <span class="token keyword">return</span> access_token
</code></pre></div><p>在视图函数中</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">qq_login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    oauth_qq <span class="token operator">=</span> OAuthQQ<span class="token punctuation">(</span>client_id<span class="token operator">=</span>QQ_APP_ID<span class="token punctuation">,</span> client_key<span class="token operator">=</span>QQ_KEY<span class="token punctuation">,</span>redirect_uri<span class="token operator">=</span>QQ_RECALL_URI<span class="token punctuation">)</span>

    <span class="token comment"># 获取Code</span>
    request_code <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span> <span class="token comment"># 重点标记</span>
    <span class="token comment"># 获取Token</span>
    access_token <span class="token operator">=</span> oauth_qq<span class="token punctuation">.</span>get_access_token<span class="token punctuation">(</span>request_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span> 
</code></pre></div><hr> <p>获取授权ID</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_open_id</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''获取QQ的OpenID'''</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'access_token'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>access_token
    <span class="token punctuation">}</span>
    url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/oauth2.0/me'</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span>text
    r_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment"># 去掉callback</span>
    r_json <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>r_str<span class="token punctuation">)</span>

    openid <span class="token operator">=</span> r_json<span class="token punctuation">[</span><span class="token string">'openid'</span><span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>openid <span class="token operator">=</span> openid
    <span class="token keyword">return</span> openid
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_qq_info</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''获取用户资料信息'''</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'access_token'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
        <span class="token string">'oauth_consumer_key'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
        <span class="token string">'openid'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>openid
    <span class="token punctuation">}</span>

    url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/user/get_user_info'</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span>text

    info <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token keyword">return</span> info
</code></pre></div><p>完整的<code>oauth_qq.py</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlencode
<span class="token keyword">import</span>  requests
<span class="token keyword">import</span> json

<span class="token keyword">class</span> <span class="token class-name">OAuthQQ</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client_id<span class="token punctuation">,</span> client_key<span class="token punctuation">,</span> redirect_uri<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client_id
        self<span class="token punctuation">.</span>client_key <span class="token operator">=</span> client_key
        self<span class="token punctuation">.</span>redirect_uri <span class="token operator">=</span> redirect_uri

    <span class="token keyword">def</span> <span class="token function">get_auth_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        获取授权页面的网址
        '''</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'which'</span><span class="token punctuation">:</span> <span class="token string">'Login'</span><span class="token punctuation">,</span>
            <span class="token string">'display'</span><span class="token punctuation">:</span> <span class="token string">'pc'</span><span class="token punctuation">,</span>
            <span class="token string">'response_type'</span><span class="token punctuation">:</span> <span class="token string">'code'</span><span class="token punctuation">,</span>
            <span class="token string">'client_id'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
            <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>redirect_uri<span class="token punctuation">,</span>
            <span class="token string">'scope'</span><span class="token punctuation">:</span> <span class="token string">'get_user_info'</span><span class="token punctuation">,</span>
            <span class="token string">'state'</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/oauth2.0/show?%s'</span><span class="token operator">%</span>urlencode<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
        <span class="token keyword">return</span> url

    <span class="token keyword">def</span> <span class="token function">get_access_token</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        根据Code获取access_token
        '''</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'grant_type'</span><span class="token punctuation">:</span> <span class="token string">'authorization_code'</span><span class="token punctuation">,</span>
            <span class="token string">'client_id'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
            <span class="token string">'client_secret'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_key<span class="token punctuation">,</span>
            <span class="token string">'code'</span><span class="token punctuation">:</span> code<span class="token punctuation">,</span>
            <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>redirect_uri
        <span class="token punctuation">}</span>
        url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/oauth2.0/token?%s'</span><span class="token operator">%</span>urlencode<span class="token punctuation">(</span>params<span class="token punctuation">)</span>

        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>text
        <span class="token comment"># access_token=851BA27D849C1B4F913F6024C373BA17&amp;expires_in=7776000&amp;refresh_token=873139F27AB656AAE3D40A84E534A80C</span>
        access_token <span class="token operator">=</span> response<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>access_token <span class="token operator">=</span> access_token
        <span class="token keyword">return</span> access_token

    <span class="token keyword">def</span> <span class="token function">get_open_id</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''获取QQ的OpenID'''</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'access_token'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>access_token
        <span class="token punctuation">}</span>
        url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/oauth2.0/me'</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span>text
        r_str <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment"># 去掉callback</span>
        r_json <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>r_str<span class="token punctuation">)</span>

        openid <span class="token operator">=</span> r_json<span class="token punctuation">[</span><span class="token string">'openid'</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>openid <span class="token operator">=</span> openid
        <span class="token keyword">return</span> openid

    <span class="token keyword">def</span> <span class="token function">get_qq_info</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''获取用户资料信息'''</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'access_token'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
            <span class="token string">'oauth_consumer_key'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
            <span class="token string">'openid'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>openid
        <span class="token punctuation">}</span>

        url <span class="token operator">=</span> <span class="token string">'https://graph.qq.com/user/get_user_info'</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span>text

        info <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token keyword">return</span> info
</code></pre></div><p>视图函数</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> <span class="token punctuation">.</span>oauth_qq <span class="token keyword">import</span> OAuthQQ <span class="token comment"># 导入工具类</span>

<span class="token keyword">def</span> <span class="token function">qq_login</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    oauth_qq <span class="token operator">=</span> OAuthQQ<span class="token punctuation">(</span>client_id<span class="token operator">=</span>QQ_APP_ID<span class="token punctuation">,</span> client_key<span class="token operator">=</span>QQ_KEY<span class="token punctuation">,</span>redirect_uri<span class="token operator">=</span>QQ_RECALL_URI<span class="token punctuation">)</span>

    <span class="token comment"># 获取Code</span>
    request_code <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">)</span>
    <span class="token comment"># 获取Token</span>
    access_token <span class="token operator">=</span> oauth_qq<span class="token punctuation">.</span>get_access_token<span class="token punctuation">(</span>request_code<span class="token punctuation">)</span>
    <span class="token comment"># 获取OpenID</span>
    open_id <span class="token operator">=</span> oauth_qq<span class="token punctuation">.</span>get_open_id<span class="token punctuation">(</span><span class="token punctuation">)</span>



    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'AccessToken:'</span> <span class="token operator">+</span> access_token<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;OpenID: &quot;</span><span class="token operator">+</span>  open_id<span class="token punctuation">)</span>
    
    infos <span class="token operator">=</span> oauth_qq<span class="token punctuation">.</span>get_qq_info<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>infos<span class="token punctuation">)</span>
    
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'Ok'</span><span class="token punctuation">)</span>
</code></pre></div><hr> <p>目前已完成的部分</p> <p><img src="http://cdn.itaolaity.com/20200428230139.png" alt=""></p> <h3 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h3> <p>https://www.jianshu.com/p/76f9682634e2</p> <p><a href="https://wiki.connect.qq.com/%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7openid_oauth2-0" target="_blank" rel="noopener noreferrer">https://wiki.connect.qq.com/%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7openid_oauth2-0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>https://liuyanzhao.com/8210.html</p></div> <!----></article> <!----> <!----></main></div></div><div class="global-ui"><div class="reading-progress top" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div></div></div>
    <script src="/assets/js/app.142c00a5.js" defer></script><script src="/assets/js/7.a35a4700.js" defer></script><script src="/assets/js/35.219991cc.js" defer></script>
  </body>
</html>
