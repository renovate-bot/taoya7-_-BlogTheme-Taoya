<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1-Celery简单使用 | Taoya</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC|Open+Sans|Poppins|Source+Sans+Pro|Ubuntu&amp;display=swap">
    <script src="/parallax.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/gsap/3.2.6/gsap.min.js"></script>
    <meta name="description" content="多言数穷，不如守中">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.00fdc26d.css" as="style"><link rel="preload" href="/assets/js/app.c2c1968b.js" as="script"><link rel="preload" href="/assets/js/7.96aa0c69.js" as="script"><link rel="preload" href="/assets/js/63.f4f2ab18.js" as="script"><link rel="prefetch" href="/assets/js/1.d886842f.js"><link rel="prefetch" href="/assets/js/10.b4cbacd4.js"><link rel="prefetch" href="/assets/js/11.4dcc70b0.js"><link rel="prefetch" href="/assets/js/12.5d3cae48.js"><link rel="prefetch" href="/assets/js/13.81d52903.js"><link rel="prefetch" href="/assets/js/14.54e547ee.js"><link rel="prefetch" href="/assets/js/15.4c18c262.js"><link rel="prefetch" href="/assets/js/16.df779644.js"><link rel="prefetch" href="/assets/js/17.51c1142c.js"><link rel="prefetch" href="/assets/js/18.c2ba6705.js"><link rel="prefetch" href="/assets/js/19.afccd4f0.js"><link rel="prefetch" href="/assets/js/2.258cf35c.js"><link rel="prefetch" href="/assets/js/20.9523cfa0.js"><link rel="prefetch" href="/assets/js/21.02d839bd.js"><link rel="prefetch" href="/assets/js/22.c1d1793f.js"><link rel="prefetch" href="/assets/js/23.7460123d.js"><link rel="prefetch" href="/assets/js/24.057d205c.js"><link rel="prefetch" href="/assets/js/25.8938e986.js"><link rel="prefetch" href="/assets/js/26.d87b38f7.js"><link rel="prefetch" href="/assets/js/27.4d8ef5e1.js"><link rel="prefetch" href="/assets/js/28.99d099a0.js"><link rel="prefetch" href="/assets/js/29.0ddb3a7b.js"><link rel="prefetch" href="/assets/js/30.f9351291.js"><link rel="prefetch" href="/assets/js/31.406ddb6b.js"><link rel="prefetch" href="/assets/js/32.5f5c65df.js"><link rel="prefetch" href="/assets/js/33.dfeebc84.js"><link rel="prefetch" href="/assets/js/34.401005c9.js"><link rel="prefetch" href="/assets/js/35.f877f60b.js"><link rel="prefetch" href="/assets/js/36.ea3761ea.js"><link rel="prefetch" href="/assets/js/37.9d43c85f.js"><link rel="prefetch" href="/assets/js/38.80203c11.js"><link rel="prefetch" href="/assets/js/39.ea3c236e.js"><link rel="prefetch" href="/assets/js/40.aece6790.js"><link rel="prefetch" href="/assets/js/41.071f7b84.js"><link rel="prefetch" href="/assets/js/42.b3c814d1.js"><link rel="prefetch" href="/assets/js/43.70442cf7.js"><link rel="prefetch" href="/assets/js/44.a4499e5c.js"><link rel="prefetch" href="/assets/js/45.0ea716a8.js"><link rel="prefetch" href="/assets/js/46.416cf609.js"><link rel="prefetch" href="/assets/js/47.df03dc74.js"><link rel="prefetch" href="/assets/js/48.df90205d.js"><link rel="prefetch" href="/assets/js/49.1a0758db.js"><link rel="prefetch" href="/assets/js/5.a5f98c38.js"><link rel="prefetch" href="/assets/js/50.755b1f46.js"><link rel="prefetch" href="/assets/js/51.6805f50a.js"><link rel="prefetch" href="/assets/js/52.baa0f589.js"><link rel="prefetch" href="/assets/js/53.5038a97d.js"><link rel="prefetch" href="/assets/js/54.83971f86.js"><link rel="prefetch" href="/assets/js/55.0a62a270.js"><link rel="prefetch" href="/assets/js/56.b097d1b9.js"><link rel="prefetch" href="/assets/js/57.d8d63d6d.js"><link rel="prefetch" href="/assets/js/58.7e0cd620.js"><link rel="prefetch" href="/assets/js/59.81a7b043.js"><link rel="prefetch" href="/assets/js/6.54279ef5.js"><link rel="prefetch" href="/assets/js/60.79178e1c.js"><link rel="prefetch" href="/assets/js/61.432ef54b.js"><link rel="prefetch" href="/assets/js/62.a58fafaf.js"><link rel="prefetch" href="/assets/js/64.e6400881.js"><link rel="prefetch" href="/assets/js/65.9ed92c96.js"><link rel="prefetch" href="/assets/js/66.8d00c347.js"><link rel="prefetch" href="/assets/js/67.678f428f.js"><link rel="prefetch" href="/assets/js/68.02d8e5dc.js"><link rel="prefetch" href="/assets/js/69.1081a8b7.js"><link rel="prefetch" href="/assets/js/70.e76f6080.js"><link rel="prefetch" href="/assets/js/71.d8caec13.js"><link rel="prefetch" href="/assets/js/72.3000a87b.js"><link rel="prefetch" href="/assets/js/73.f5aa908c.js"><link rel="prefetch" href="/assets/js/74.5d3e2c65.js"><link rel="prefetch" href="/assets/js/75.417ebdc1.js"><link rel="prefetch" href="/assets/js/76.41c30b78.js"><link rel="prefetch" href="/assets/js/77.9c9b5e86.js"><link rel="prefetch" href="/assets/js/78.d78bb285.js"><link rel="prefetch" href="/assets/js/79.b84b731e.js"><link rel="prefetch" href="/assets/js/8.31b10017.js"><link rel="prefetch" href="/assets/js/80.fc109156.js"><link rel="prefetch" href="/assets/js/81.2ebfa7c2.js"><link rel="prefetch" href="/assets/js/82.4478a7c4.js"><link rel="prefetch" href="/assets/js/9.24d6651a.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.eb9498ce.js">
    <link rel="stylesheet" href="/assets/css/0.styles.00fdc26d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="taolin"><header class="tl-header"><div class="wrap"><div class="tl-logo"><h1><a href="/" class="router-link-active"><svg width="360" height="360" viewBox="0 0 360 360" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><rect width="360" height="360" fill="black"></rect> <path d="M314 217.328C314 222.203 312.453 228.719 309.359 236.875C301.391 258.25 286.109 274.703 263.516 286.234C243.734 296.359 221.469 301.422 196.719 301.422C163.25 301.422 137.984 292.516 120.922 274.703C105.453 258.578 97.7188 236.5 97.7188 208.469C97.7188 186.062 103.016 162.484 113.609 137.734C121.016 120.672 128.562 107.266 136.25 97.5156C109.438 100.516 85.4375 110.406 64.25 127.188C63.125 128.406 62.375 128.312 62 126.906C60.0312 114.344 57.4531 93.9062 54.2656 65.5938C54.3594 65.0312 54.9219 64.5625 55.9531 64.1875C130.203 70.4688 207.5 73.6094 287.844 73.6094C289.438 73.6094 290 74.5938 289.531 76.5625C279.688 115.281 273.641 146.266 271.391 169.516C264.641 168.484 255.922 166.75 245.234 164.312C240.172 162.625 237.641 160.047 237.641 156.578C237.641 154.703 238.344 150.531 239.75 144.062C241.25 137.5 242 132.625 242 129.438C242 124.844 240.547 121.609 237.641 119.734C220.859 108.672 207.547 102.438 197.703 101.031C180.734 133 172.25 168.391 172.25 207.203C172.25 228.766 175.484 246.484 181.953 260.359C188.891 275.453 198.453 283 210.641 283C219.734 283 229.719 279.391 240.594 272.172C250.719 265.328 255.781 259.797 255.781 255.578C255.781 253.891 255.219 253.047 254.094 253.047C239.938 250.891 227.797 246.25 217.672 239.125C205.672 230.781 199.672 220.656 199.672 208.75C199.672 202.375 203.891 197.125 212.328 193C220.859 188.875 232.391 186.812 246.922 186.812C253.391 186.812 260.984 187.375 269.703 188.5C299.234 192.438 314 202.047 314 217.328Z" fill="white"></path></g> <defs><clipPath id="clip0"><rect width="360" height="360" fill="white"></rect></clipPath></defs></svg></a></h1> <span>Taoya</span></div> <nav class="tl-menu"><ul class="tl-menu-list"><li class="tl-menu-item"><a href="/blog/"><span>技术</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li><li class="tl-menu-item"><a href="/about/"><span>关于</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li><li class="tl-menu-item"><a href="/life/"><span>记录</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li></ul> <div class="tl-menu-trigger"><button class="menu-btn"><svg viewBox="0 0 64 48"><path d="M19,15 L45,15 C70,15 58,-2 49.0177126,7 L19,37"></path> <path d="M19,24 L45,24 C61.2371586,24 57,49 41,33 L32,24"></path> <path d="M45,33 L19,33 C-8,33 6,-2 22,14 L45,37"></path></svg></button></div> <div class="tl-hamburger"><div class="menu-secondary-background-color"></div> <div class="tl-menu-overlay"><div class="tl-f-nav-list"><div class="menu-background"></div> <div class="container"><div class="tl-f-nav-col"><h3 class="tl-f-nav-item"><a href="/blog"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       01
                                   </div> <div class="tl-menu-name">
                                       技术
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/about"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       02
                                   </div> <div class="tl-menu-name">
                                       关于
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/life"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       03
                                   </div> <div class="tl-menu-name">
                                       生活记录
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3></div></div></div></div></div></nav></div></header> <div id="article-post" data-scroll=""><main class="container"><div class="back"><div class="icon-wrap"><svg aria-hidden="true" class="icon"><use xlink:href="#icon-fanhui"></use></svg></div></div> <header><h1 class="title">1-Celery简单使用</h1> <div class="time"><span class="month">06</span> <span>/ <span>17</span></span></div></header> <article class="tl-article-container"><!----> <div class="content__default"><h3 id="简介"><a href="#简介" class="header-anchor"></a> 简介</h3> <p>Celery是一个简单、灵活且可靠的，处理大量消息的<u>分布式系统</u></p> <p>专注于实时处理的异步任务队列。</p> <p>Celery通过将功能的一部分作为延迟任务运行在与其他任务相同的服务器上或在其他服务器上，从而降低了性能负载。</p> <p><strong>使用场景</strong></p> <p>异步任务：一些耗时的操作可以交给Celery执行。而不用等待程序执行完毕才知道结果。</p> <p>定时任务：比如定时推送消息，定时爬取消息，定时统计数据等。</p> <hr> <blockquote><p><strong>Celery架构</strong></p> <p>Celery架构由三部分组成，消息中间件<code>message broker</code> . 任务执行单元<code>worker</code>  . 任务结果存储<code>task result store</code> 组成</p> <p><strong>消息中间件</strong></p> <p>Celery本身不提供消息服务，但是可以方便的和第三方提供的消息中间件集成。包括，<u>RabbitMQ</u>, <u>Redis</u> <u>Zookeeper</u> 等等</p> <p><strong>任务执行单元</strong></p> <p>Worker是Celery提供的任务执行的单元，worker并发的运行在分布式的系统节点中</p> <p><strong>任务结果存储</strong></p> <p>Task result store用来存储Worker执行的任务的结果，Celery支持以不同方式存储任务的结果，包括AMQP, redis等</p></blockquote> <p><img src="http://alicdn.itaolaity.com/img/20200617095937.png" alt=""></p> <blockquote><p>celery是一个强大的 分布式任务队列的异步处理框架，它可以让任务的执行完全脱离主程序，甚至可以被分配到其他主机上运行。我们通常使用它来实现异步任务<code>async task</code>和定时任务<code>crontab</code></p> <p><strong>异步任务</strong>：将耗时操作任务提交给Celery去异步执行，比如发送短信/邮件、消息推送、音视频处理等等</p> <p>**定时任务：**定时执行某件事情，比如每天数据统计</p></blockquote> <p><strong>Celery使用流程</strong></p> <ol><li><p>创建APP+任务函数</p></li> <li><p>启动Celery()服务</p> <div class="language-shell extra-class"><pre class="language-shell"><code>celery worker -A ___ --loginfo info
</code></pre></div></li> <li><p>添加任务：手动添加</p></li> <li><p>获取结果：手动获取</p></li></ol> <h3 id="【demo】简单使用-异步任务"><a href="#【demo】简单使用-异步任务" class="header-anchor"></a> 【Demo】简单使用-异步任务</h3> <ol><li><p>使用Redis作为Broker</p></li> <li><p>创建一个文件夹<code>tasks.py</code></p></li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery
<span class="token keyword">import</span> time  

<span class="token comment"># 消息中间件的地址</span>
broker <span class="token operator">=</span> <span class="token string">'redis://127.0.0.1:6379/0'</span>
<span class="token comment"># 存储结果的地址</span>
backend <span class="token operator">=</span> <span class="token string">'redis://127.0.0.1:6379/1'</span>

app <span class="token operator">=</span> Celery<span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">,</span> broker<span class="token operator">=</span>broker<span class="token punctuation">,</span> backend<span class="token operator">=</span>backend<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>task</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;添加操作...{}+{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;添加操作已完成...&quot;</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> x<span class="token operator">+</span>y                       
</code></pre></div><p>然后启动</p> <div class="language-shell extra-class"><pre class="language-shell"><code>celery worker -A tasks  --loglevel<span class="token operator">=</span>info -P gevent

worker
- A tasks 选择tasks.py
--loglevel 日志级别 <span class="token comment"># 简写 -l</span>
</code></pre></div><p><img src="http://alicdn.itaolaity.com/img/20200616114915.png" alt=""></p> <p>**<u>生产者</u>**打开终端</p> <p><code>xxx.delay()</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@Taoya ~<span class="token punctuation">]</span><span class="token comment"># python3</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> from tasks <span class="token function">import</span> <span class="token function">add</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> add.delay<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>AsyncResult: 04d02448-e3e1-482c-ad3f-eaa09be82b6<span class="token operator"><span class="token file-descriptor important">5</span>&gt;</span>

result <span class="token operator">=</span> add.delay<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">)</span> <span class="token comment"># 添加到任务队列，并获取任务ID</span>
print<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
fc670bd6-428d-4b0b-b230-50c66c644ce3
</code></pre></div><p>同时看到</p> <p><img src="http://alicdn.itaolaity.com/img/20200618180338.png" alt=""></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># Redis 查看任务结果</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;SUCCESS&quot;</span>,
    <span class="token string">&quot;result&quot;</span>:3,
    <span class="token string">&quot;traceback&quot;</span>:null,
    <span class="token string">&quot;children&quot;</span>:<span class="token punctuation">[</span><span class="token punctuation">]</span>,
    <span class="token string">&quot;date_done&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2020-06-17T02:42:37.977013&quot;</span>,
    <span class="token string">&quot;task_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;04d02448-e3e1-482c-ad3f-eaa09be82b65&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="http://alicdn.itaolaity.com/img/20200617104420.png" alt=""></p> <h4 id="查看完成状态"><a href="#查看完成状态" class="header-anchor"></a> 查看完成状态</h4> <p>创建一个<code>result.py</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> celery<span class="token punctuation">.</span>result <span class="token keyword">import</span> AsyncResult

<span class="token keyword">from</span> tasks <span class="token keyword">import</span> add

async_result<span class="token operator">=</span>AsyncResult<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">&quot;b2a4872e-2d68-4dfb-a0e7-3b359f1abfe8&quot;</span><span class="token punctuation">,</span> app<span class="token operator">=</span>add<span class="token punctuation">)</span>

<span class="token keyword">if</span> async_result<span class="token punctuation">.</span>successful<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> async_result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token comment"># result.forget() # 将结果删除</span>
<span class="token keyword">elif</span> async_result<span class="token punctuation">.</span>failed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'执行失败'</span><span class="token punctuation">)</span>
<span class="token keyword">elif</span> async_result<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'PENDING'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'任务等待中被执行'</span><span class="token punctuation">)</span>
<span class="token keyword">elif</span> async_result<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'RETRY'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'任务异常后正在重试'</span><span class="token punctuation">)</span>
<span class="token keyword">elif</span> async_result<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token string">'STARTED'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'任务已经开始被执行'</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="http://alicdn.itaolaity.com/img/20200618180959.png" alt=""></p> <hr> <h3 id="celery的核心模块"><a href="#celery的核心模块" class="header-anchor"></a> Celery的核心模块</h3> <p><code>task</code></p> <ul><li>异步任务</li> <li>定时任务</li></ul> <p><code>broker</code> 中间人</p> <p>接收生产者发来的消息即Task，将任务存入队列。任务的消费者是Worker</p> <blockquote><p>Celery本身不提供队列服务，推荐用Redis或RabbitMQ实现队列服务</p></blockquote> <p><code>Worker</code></p> <p>执行任务的单元，它实时监控消息队列，如果有任务就获取任务并执行它</p> <p><code>Beat</code></p> <p>定时任务调度器，根据配置定时将任务发送给Broker</p> <p><code>Backend</code></p> <p>用于存储任务的执行结果</p> <p><img src="http://alicdn.itaolaity.com/img/20200616122652.png" alt=""></p> <h3 id="【demo】多任务结构"><a href="#【demo】多任务结构" class="header-anchor"></a> 【Demo】多任务结构</h3> <p>假如我们有多个任务需要处理</p> <p><img src="http://alicdn.itaolaity.com/img/20200618183223.png" alt=""></p> <h3 id="【demo】-定时任务"><a href="#【demo】-定时任务" class="header-anchor"></a> 【Demo】 定时任务</h3> <p><code>tasks.py</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery
<span class="token keyword">import</span> time
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime


broker <span class="token operator">=</span> <span class="token string">'redis://127.0.0.1:6379/0'</span>
backend <span class="token operator">=</span> <span class="token string">'redis://127.0.0.1:6379/1'</span>

app <span class="token operator">=</span> Celery<span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">,</span> broker<span class="token operator">=</span>broker<span class="token punctuation">,</span> backend<span class="token operator">=</span>backend<span class="token punctuation">)</span>

app<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>timezone <span class="token operator">=</span> <span class="token string">'Asia/Shanghai'</span>
app<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>enable_utc <span class="token operator">=</span> <span class="token boolean">False</span>



<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>task</span>
<span class="token keyword">def</span> <span class="token function">say</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Hello, '</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'say ok'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'success'</span>
</code></pre></div><p><code>produce_tasks.py</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> tasks <span class="token keyword">import</span> say <span class="token comment"># 导入</span>
 
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token comment"># 方案1</span>
v1 <span class="token operator">=</span> datetime<span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">00</span><span class="token punctuation">)</span> <span class="token comment"># 确定具体的时间</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span>

<span class="token comment"># 方案2 多少时间以后</span>
ctime <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
utc_ctime <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcfromtimestamp<span class="token punctuation">(</span>ctime<span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta
time_delay <span class="token operator">=</span> timedelta<span class="token punctuation">(</span>seconds<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
task_time <span class="token operator">=</span> utc_ctime <span class="token operator">+</span> time_delay



result <span class="token operator">=</span> say<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'张三'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> eta<span class="token operator">=</span>v1<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="监控celery"><a href="#监控celery" class="header-anchor"></a> 监控Celery</h3> <p>有一个方便的基于Web的工具，称为<a href="http://flower.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener noreferrer">Flower<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，可用于监视和管理芹菜群集。Flower提供了任务进度和历史记录的详细统计信息，还显示了其他任务详细信息，例如传递的参数，开始时间，运行时等。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>pip <span class="token function">install</span> flower
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>$ celery -A tasks worker -l info -P gevent
</code></pre></div><p>再打开一个终端，接着启动flower</p> <div class="language-shell extra-class"><pre class="language-shell"><code>λ celery -A tasks flower

<span class="token punctuation">[</span>I <span class="token number">200617</span> <span class="token number">10</span>:58:06 command:136<span class="token punctuation">]</span> Visit me at http://localhost:5555
<span class="token punctuation">[</span>I <span class="token number">200617</span> <span class="token number">10</span>:58:06 command:141<span class="token punctuation">]</span> Broker: redis://127.0.0.1:6379/0
<span class="token punctuation">[</span>I <span class="token number">200617</span> <span class="token number">10</span>:58:06 command:144<span class="token punctuation">]</span> Registered tasks:
    <span class="token punctuation">[</span><span class="token string">'celery.accumulate'</span>,
     <span class="token string">'celery.backend_cleanup'</span>,
     <span class="token string">'celery.chain'</span>,
     <span class="token string">'celery.chord'</span>,
     <span class="token string">'celery.chord_unlock'</span>,
     <span class="token string">'celery.chunks'</span>,
     <span class="token string">'celery.group'</span>,
     <span class="token string">'celery.map'</span>,
     <span class="token string">'celery.starmap'</span>,
     <span class="token string">'tasks.add'</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>I <span class="token number">200617</span> <span class="token number">10</span>:58:06 mixins:229<span class="token punctuation">]</span> Connected to redis://127.0.0.1:6379/0
</code></pre></div><p><img src="http://alicdn.itaolaity.com/img/20200617110656.png" alt=""></p> <ul><li>任务列表</li></ul> <p><img src="http://alicdn.itaolaity.com/img/20200617110709.png" alt=""></p> <ul><li><code>Broker</code></li></ul> <p><img src="http://alicdn.itaolaity.com/img/20200617111439.png" alt=""></p> <h3 id="其他"><a href="#其他" class="header-anchor"></a> 其他</h3> <p>可以使用以下命令删除所有待处理任务</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ celery -A tasks purge
</code></pre></div><h3 id="问题"><a href="#问题" class="header-anchor"></a> 问题</h3> <h4 id="解决windows调试错误"><a href="#解决windows调试错误" class="header-anchor"></a> 解决Windows调试错误</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>pip <span class="token function">install</span> eventlet

celery -A <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span> worker -l info -P eventlet
</code></pre></div><p>如果还是报错请尝试<code>gevent</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>pip <span class="token function">install</span> gevent
celery -A <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span> worker -l info -P gevent
</code></pre></div><h3 id="参考"><a href="#参考" class="header-anchor"></a> 参考</h3> <p><a href="https://github.com/mher/flower" target="_blank" rel="noopener noreferrer">flower github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://docs.celeryproject.org/en/latest/index.html" target="_blank" rel="noopener noreferrer">celery 官网文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.cnblogs.com/pyedu/p/12461819.html" target="_blank" rel="noopener noreferrer">博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div></article> <div class="tl-article-toc"><div class="vuepress-toc-item vuepress-toc-h3 active"><a href="#简介">简介</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#【demo】简单使用-异步任务">【Demo】简单使用-异步任务</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#celery的核心模块">Celery的核心模块</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#【demo】多任务结构">【Demo】多任务结构</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#【demo】-定时任务">【Demo】 定时任务</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#监控celery">监控Celery</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#其他">其他</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#问题">问题</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#参考">参考</a></div></div></main></div></div><div class="global-ui"><div class="reading-progress bottom" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div></div></div>
    <script src="/assets/js/app.c2c1968b.js" defer></script><script src="/assets/js/7.96aa0c69.js" defer></script><script src="/assets/js/63.f4f2ab18.js" defer></script>
  </body>
</html>
