<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>uwsgi+Nginx部署! | Taoya</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC|Open+Sans|Poppins|Source+Sans+Pro|Ubuntu&amp;display=swap">
    <script src="/parallax.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/gsap/3.2.6/gsap.min.js"></script>
    <meta name="description" content="多言数穷，不如守中">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.0a795576.css" as="style"><link rel="preload" href="/assets/js/app.40859fda.js" as="script"><link rel="preload" href="/assets/js/7.92b229fa.js" as="script"><link rel="preload" href="/assets/js/57.053d20a0.js" as="script"><link rel="prefetch" href="/assets/js/1.75852b01.js"><link rel="prefetch" href="/assets/js/10.872a3fbb.js"><link rel="prefetch" href="/assets/js/11.39c5ca26.js"><link rel="prefetch" href="/assets/js/12.e4bddfb9.js"><link rel="prefetch" href="/assets/js/13.f155a133.js"><link rel="prefetch" href="/assets/js/14.e6a333af.js"><link rel="prefetch" href="/assets/js/15.e1a57c06.js"><link rel="prefetch" href="/assets/js/16.e7b19503.js"><link rel="prefetch" href="/assets/js/17.fc08e702.js"><link rel="prefetch" href="/assets/js/18.61990770.js"><link rel="prefetch" href="/assets/js/19.2b879ccc.js"><link rel="prefetch" href="/assets/js/2.5fba5071.js"><link rel="prefetch" href="/assets/js/20.cfc78786.js"><link rel="prefetch" href="/assets/js/21.85195225.js"><link rel="prefetch" href="/assets/js/22.6f91e1e7.js"><link rel="prefetch" href="/assets/js/23.2b2f11da.js"><link rel="prefetch" href="/assets/js/24.526be228.js"><link rel="prefetch" href="/assets/js/25.8938e986.js"><link rel="prefetch" href="/assets/js/26.36af3555.js"><link rel="prefetch" href="/assets/js/27.4aead95f.js"><link rel="prefetch" href="/assets/js/28.94f55e93.js"><link rel="prefetch" href="/assets/js/29.5606204c.js"><link rel="prefetch" href="/assets/js/30.3cdaff1f.js"><link rel="prefetch" href="/assets/js/31.a062d7b9.js"><link rel="prefetch" href="/assets/js/32.359b8a88.js"><link rel="prefetch" href="/assets/js/33.a7ccb1bb.js"><link rel="prefetch" href="/assets/js/34.c6ca5034.js"><link rel="prefetch" href="/assets/js/35.845d03c0.js"><link rel="prefetch" href="/assets/js/36.586b1fd0.js"><link rel="prefetch" href="/assets/js/37.bf2da47a.js"><link rel="prefetch" href="/assets/js/38.80461a0d.js"><link rel="prefetch" href="/assets/js/39.7a6b8ae2.js"><link rel="prefetch" href="/assets/js/40.67d93bab.js"><link rel="prefetch" href="/assets/js/41.e7397f6f.js"><link rel="prefetch" href="/assets/js/42.90d01676.js"><link rel="prefetch" href="/assets/js/43.8e0bc281.js"><link rel="prefetch" href="/assets/js/44.adeb7103.js"><link rel="prefetch" href="/assets/js/45.4fd77516.js"><link rel="prefetch" href="/assets/js/46.c22951a1.js"><link rel="prefetch" href="/assets/js/47.e360d022.js"><link rel="prefetch" href="/assets/js/48.27cfe0d7.js"><link rel="prefetch" href="/assets/js/49.0243ea69.js"><link rel="prefetch" href="/assets/js/5.63a823e8.js"><link rel="prefetch" href="/assets/js/50.c8bbf170.js"><link rel="prefetch" href="/assets/js/51.972ad12e.js"><link rel="prefetch" href="/assets/js/52.94770192.js"><link rel="prefetch" href="/assets/js/53.e629d1be.js"><link rel="prefetch" href="/assets/js/54.cd4ccb97.js"><link rel="prefetch" href="/assets/js/55.ba74bcd9.js"><link rel="prefetch" href="/assets/js/56.ec779212.js"><link rel="prefetch" href="/assets/js/58.40e5b7c2.js"><link rel="prefetch" href="/assets/js/59.7c2ca6a0.js"><link rel="prefetch" href="/assets/js/6.e8274803.js"><link rel="prefetch" href="/assets/js/60.043bec3b.js"><link rel="prefetch" href="/assets/js/61.332f6d21.js"><link rel="prefetch" href="/assets/js/62.0119a09f.js"><link rel="prefetch" href="/assets/js/63.1c4ffaa5.js"><link rel="prefetch" href="/assets/js/64.61f885bf.js"><link rel="prefetch" href="/assets/js/65.a00bdf79.js"><link rel="prefetch" href="/assets/js/66.4f3bc0ca.js"><link rel="prefetch" href="/assets/js/67.5673aa98.js"><link rel="prefetch" href="/assets/js/68.9f871a79.js"><link rel="prefetch" href="/assets/js/69.1081a8b7.js"><link rel="prefetch" href="/assets/js/70.d4c980e2.js"><link rel="prefetch" href="/assets/js/71.be1daf85.js"><link rel="prefetch" href="/assets/js/72.b306842f.js"><link rel="prefetch" href="/assets/js/73.65c8494f.js"><link rel="prefetch" href="/assets/js/74.c3c2262b.js"><link rel="prefetch" href="/assets/js/75.70ab37cf.js"><link rel="prefetch" href="/assets/js/76.3af4cac5.js"><link rel="prefetch" href="/assets/js/77.b84ddacd.js"><link rel="prefetch" href="/assets/js/78.2236464f.js"><link rel="prefetch" href="/assets/js/8.42e8863a.js"><link rel="prefetch" href="/assets/js/9.1b471913.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.235cd43c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0a795576.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="taolin"><header class="tl-header"><div class="wrap"><div class="tl-logo"><h1><a href="/" class="router-link-active"><svg width="360" height="360" viewBox="0 0 360 360" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><rect width="360" height="360" fill="black"></rect> <path d="M314 217.328C314 222.203 312.453 228.719 309.359 236.875C301.391 258.25 286.109 274.703 263.516 286.234C243.734 296.359 221.469 301.422 196.719 301.422C163.25 301.422 137.984 292.516 120.922 274.703C105.453 258.578 97.7188 236.5 97.7188 208.469C97.7188 186.062 103.016 162.484 113.609 137.734C121.016 120.672 128.562 107.266 136.25 97.5156C109.438 100.516 85.4375 110.406 64.25 127.188C63.125 128.406 62.375 128.312 62 126.906C60.0312 114.344 57.4531 93.9062 54.2656 65.5938C54.3594 65.0312 54.9219 64.5625 55.9531 64.1875C130.203 70.4688 207.5 73.6094 287.844 73.6094C289.438 73.6094 290 74.5938 289.531 76.5625C279.688 115.281 273.641 146.266 271.391 169.516C264.641 168.484 255.922 166.75 245.234 164.312C240.172 162.625 237.641 160.047 237.641 156.578C237.641 154.703 238.344 150.531 239.75 144.062C241.25 137.5 242 132.625 242 129.438C242 124.844 240.547 121.609 237.641 119.734C220.859 108.672 207.547 102.438 197.703 101.031C180.734 133 172.25 168.391 172.25 207.203C172.25 228.766 175.484 246.484 181.953 260.359C188.891 275.453 198.453 283 210.641 283C219.734 283 229.719 279.391 240.594 272.172C250.719 265.328 255.781 259.797 255.781 255.578C255.781 253.891 255.219 253.047 254.094 253.047C239.938 250.891 227.797 246.25 217.672 239.125C205.672 230.781 199.672 220.656 199.672 208.75C199.672 202.375 203.891 197.125 212.328 193C220.859 188.875 232.391 186.812 246.922 186.812C253.391 186.812 260.984 187.375 269.703 188.5C299.234 192.438 314 202.047 314 217.328Z" fill="white"></path></g> <defs><clipPath id="clip0"><rect width="360" height="360" fill="white"></rect></clipPath></defs></svg></a></h1> <span>Taoya</span></div> <nav class="tl-menu"><ul class="tl-menu-list"><li class="tl-menu-item"><a href="/blog/"><span>技术</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li><li class="tl-menu-item"><a href="/about/"><span>关于</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li><li class="tl-menu-item"><a href="/life/"><span>记录</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li></ul> <div class="tl-menu-trigger"><button class="menu-btn"><svg viewBox="0 0 64 48"><path d="M19,15 L45,15 C70,15 58,-2 49.0177126,7 L19,37"></path> <path d="M19,24 L45,24 C61.2371586,24 57,49 41,33 L32,24"></path> <path d="M45,33 L19,33 C-8,33 6,-2 22,14 L45,37"></path></svg></button></div> <div class="tl-hamburger"><div class="menu-secondary-background-color"></div> <div class="tl-menu-overlay"><div class="tl-f-nav-list"><div class="menu-background"></div> <div class="container"><div class="tl-f-nav-col"><h3 class="tl-f-nav-item"><a href="/blog"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       01
                                   </div> <div class="tl-menu-name">
                                       技术
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/about"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       02
                                   </div> <div class="tl-menu-name">
                                       关于
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/life"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       03
                                   </div> <div class="tl-menu-name">
                                       生活记录
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3></div></div></div></div></div></nav></div></header> <div id="article-post" data-scroll=""><main class="container"><div class="back"><div class="icon-wrap"><svg aria-hidden="true" class="icon"><use xlink:href="#icon-fanhui"></use></svg></div></div> <header><h1 class="title">uwsgi+Nginx部署!</h1> <div class="time"><span class="month">05</span> <span>/ <span>03</span></span></div></header> <article class="tl-article-container"><!----> <div class="content__default"><p>Django框架内置的服务器，仅适用于开发目的。并且不能很好的扩展。生产部署环境我们选用WSGI兼容服务器。</p> <h3 id="环境"><a href="#环境" class="header-anchor"></a> 环境</h3> <blockquote><p><code>CenterOS</code></p> <p><code>Python 3.7.6</code></p> <p><code>Nginx 1.16</code></p></blockquote> <h2 id="部署"><a href="#部署" class="header-anchor"></a> 部署</h2> <p><strong>基本配置</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>DEBUG <span class="token operator">=</span> FALSE
ALLOWSE_HOST<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 保持https连接的时间</span>
SECURE_HSTS_SECONDS <span class="token operator">=</span> <span class="token number">3600</span>
SECURE_HSTS_INCLUDE_SUBDOMAINS <span class="token operator">=</span> <span class="token boolean">True</span>
SECURE_HSTS_PRELOAD <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 自动重定向到安全连接（走HTTP自动重定向到https）</span>
SECURE_SSL_REDIRECT <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 避免跨站脚本攻击风险</span>
SECURE_CONTENT_TYPE_NOSNIFF <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token triple-quoted-string string">'''
避免会自动推断内容去执行
'''</span>

<span class="token comment"># 避免跨站脚本攻击（XSS）</span>
SECURE_BROWSER_XSS_FILTER<span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token triple-quoted-string string">'''
避免js脚本攻击
'''</span>

<span class="token comment"># COOKIE只能通过HtTPS进行传输</span>
SESSION_COOKIE_SECURE<span class="token operator">=</span> <span class="token boolean">True</span>
CSRF_COOKIE_SECURE <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># 防止点击劫持攻击手段（不允许使用&lt;iframe&gt;标签进行加载）</span>
X_FRAME_OPTIONS <span class="token operator">=</span> <span class="token string">'DENY'</span>
</code></pre></div><p><img src="http://cdn.itaolaity.com/20200503152313.png" alt=""></p> <h3 id="uwsgi"><a href="#uwsgi" class="header-anchor"></a> uwsgi</h3> <p>在项目根目录创建<code>uwsgi.ini</code> 配置文件</p> <div class="language-xml extra-class"><pre class="language-xml"><code>[uwsgi]
# 直接做web服务器使用
http = 0.0.0.0:8080
# 项目目录
chdir = /home/Linis/code/test
# wsgi.py文件的目录
wsgi-file = /home/Linis/code/test/try/wsgi.py
# 指定启动的工作进程数
processes = 4
# 指定工作进程中的线程数
threads = 2

# 使用nginx连接时使用
socket = 127.0.0.1:8899
</code></pre></div><p>进入项目根目录执行<code>uwsgi uwsgi.ini</code></p> <p>测试访问正常运行</p> <p><img src="http://cdn.itaolaity.com/20200503155502.png" alt=""></p> <p><strong>运行与停止</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>启动：
uwsgi --ini uwsgi.ini
停止：
uwsgi --stop uwsgi.pid
</code></pre></div><h3 id="nginx"><a href="#nginx" class="header-anchor"></a> Nginx</h3> <div class="language-json extra-class"><pre class="language-json"><code>upstream django<span class="token punctuation">{</span>
	server <span class="token number">127.0</span>.<span class="token number">0.1</span><span class="token operator">:</span><span class="token number">8899</span>;
<span class="token punctuation">}</span>

server
<span class="token punctuation">{</span>
    listen <span class="token number">80</span>;
    server_name test.itaolaity.com;
    
    location / <span class="token punctuation">{</span>
  		include uwsgi_params;
		uwsgi_pass django;
  		uwsgi_param UWSGI_SCRIPT try.wsgi;
 		uwsgi_param UWSGI_CHDIR /home/Linis/code/test/;
	<span class="token punctuation">}</span>
	location /static <span class="token punctuation">{</span>
		alias /home/Linis/code/test/static;
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>访问域名没有问题可以正常访问。</p> <p><img src="http://cdn.itaolaity.com/20200503155641.png" alt=""></p> <div class="custom-block warning"><h3 id="静态资源访问问题"><a href="#静态资源访问问题" class="header-anchor"></a> 静态资源访问问题</h3></div> <p>现在<code>settings.py</code>配置静态资源</p> <div class="language-python extra-class"><pre class="language-python"><code>STATIC_URL <span class="token operator">=</span> <span class="token string">'/static/'</span>
STATICFILES_DIRS <span class="token operator">=</span> <span class="token punctuation">[</span>
    os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">&quot;static&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">&quot;front&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;static&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
STATIC_ROOT <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">&quot;static&quot;</span><span class="token punctuation">)</span> <span class="token comment"># 收集Django静态资源到指定目录下</span>
</code></pre></div><p>上传到服务器执行</p> <p><code>python manage.py collectstatic</code></p> <p>将静态文件打包至项目根目录下的<code>static</code>目录里</p> <p><img src="http://cdn.itaolaity.com/20200503161839.png" alt=""></p> <blockquote><p>uwsgi服务器默认不托管静态资源，一般需要配合Nginx使用(静态资源交给Nginx处理)</p></blockquote> <p>Nginx的核心配置</p> <div class="language-xml extra-class"><pre class="language-xml"><code># 收集静态文件之后，让Nginx提供静态文件，需要在Nginx配置文件中增加以下配置
location /static {
		alias /home/Linis/code/test/static;
	}
</code></pre></div><p>项目上传到服务器可以看到正常链接到</p> <p><img src="http://cdn.itaolaity.com/20200503161950.png" alt=""></p> <div class="custom-block warning"><h3 id="uwsgi-后台执行"><a href="#uwsgi-后台执行" class="header-anchor"></a> uWSGI 后台执行</h3></div> <p><code>-d</code> 参数</p> <div class="language-shell extra-class"><pre class="language-shell"><code>uwsgi -d --ini uwsgi.ini
</code></pre></div><div class="custom-block warning"><h3 id="虚拟环境使用"><a href="#虚拟环境使用" class="header-anchor"></a> 虚拟环境使用</h3></div> <p><strong>安装uwsgi</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 安装</span>
pip <span class="token function">install</span> uwsgi

<span class="token comment"># 查看</span>
uwsgi --version
<span class="token number">2.0</span>.18
</code></pre></div><p><strong>退出虚拟环境</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>deactivate
</code></pre></div></div></article> <div class="tl-article-toc"><div class="vuepress-toc-item vuepress-toc-h3 active"><a href="#环境">环境</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#部署">部署</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#uwsgi">uwsgi</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#nginx">Nginx</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#静态资源访问问题">静态资源访问问题</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#uwsgi-后台执行">uWSGI 后台执行</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#虚拟环境使用">虚拟环境使用</a></div></div></main></div></div><div class="global-ui"><!----><div class="reading-progress bottom" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div></div></div>
    <script src="/assets/js/app.40859fda.js" defer></script><script src="/assets/js/7.92b229fa.js" defer></script><script src="/assets/js/57.053d20a0.js" defer></script>
  </body>
</html>
