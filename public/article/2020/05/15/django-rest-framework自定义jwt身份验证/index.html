<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DRF自定义JWT身份验证 | Taoya</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC|Open+Sans|Poppins|Source+Sans+Pro|Ubuntu&amp;display=swap">
    <script src="/parallax.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/gsap/3.2.6/gsap.min.js"></script>
    <meta name="description" content="多言数穷，不如守中">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.0a795576.css" as="style"><link rel="preload" href="/assets/js/app.40859fda.js" as="script"><link rel="preload" href="/assets/js/7.92b229fa.js" as="script"><link rel="preload" href="/assets/js/46.c22951a1.js" as="script"><link rel="prefetch" href="/assets/js/1.75852b01.js"><link rel="prefetch" href="/assets/js/10.872a3fbb.js"><link rel="prefetch" href="/assets/js/11.39c5ca26.js"><link rel="prefetch" href="/assets/js/12.e4bddfb9.js"><link rel="prefetch" href="/assets/js/13.f155a133.js"><link rel="prefetch" href="/assets/js/14.e6a333af.js"><link rel="prefetch" href="/assets/js/15.e1a57c06.js"><link rel="prefetch" href="/assets/js/16.e7b19503.js"><link rel="prefetch" href="/assets/js/17.fc08e702.js"><link rel="prefetch" href="/assets/js/18.61990770.js"><link rel="prefetch" href="/assets/js/19.2b879ccc.js"><link rel="prefetch" href="/assets/js/2.5fba5071.js"><link rel="prefetch" href="/assets/js/20.cfc78786.js"><link rel="prefetch" href="/assets/js/21.85195225.js"><link rel="prefetch" href="/assets/js/22.6f91e1e7.js"><link rel="prefetch" href="/assets/js/23.2b2f11da.js"><link rel="prefetch" href="/assets/js/24.526be228.js"><link rel="prefetch" href="/assets/js/25.8938e986.js"><link rel="prefetch" href="/assets/js/26.36af3555.js"><link rel="prefetch" href="/assets/js/27.4aead95f.js"><link rel="prefetch" href="/assets/js/28.94f55e93.js"><link rel="prefetch" href="/assets/js/29.5606204c.js"><link rel="prefetch" href="/assets/js/30.3cdaff1f.js"><link rel="prefetch" href="/assets/js/31.a062d7b9.js"><link rel="prefetch" href="/assets/js/32.359b8a88.js"><link rel="prefetch" href="/assets/js/33.a7ccb1bb.js"><link rel="prefetch" href="/assets/js/34.c6ca5034.js"><link rel="prefetch" href="/assets/js/35.845d03c0.js"><link rel="prefetch" href="/assets/js/36.586b1fd0.js"><link rel="prefetch" href="/assets/js/37.bf2da47a.js"><link rel="prefetch" href="/assets/js/38.80461a0d.js"><link rel="prefetch" href="/assets/js/39.7a6b8ae2.js"><link rel="prefetch" href="/assets/js/40.67d93bab.js"><link rel="prefetch" href="/assets/js/41.e7397f6f.js"><link rel="prefetch" href="/assets/js/42.90d01676.js"><link rel="prefetch" href="/assets/js/43.8e0bc281.js"><link rel="prefetch" href="/assets/js/44.adeb7103.js"><link rel="prefetch" href="/assets/js/45.4fd77516.js"><link rel="prefetch" href="/assets/js/47.e360d022.js"><link rel="prefetch" href="/assets/js/48.27cfe0d7.js"><link rel="prefetch" href="/assets/js/49.0243ea69.js"><link rel="prefetch" href="/assets/js/5.63a823e8.js"><link rel="prefetch" href="/assets/js/50.c8bbf170.js"><link rel="prefetch" href="/assets/js/51.972ad12e.js"><link rel="prefetch" href="/assets/js/52.94770192.js"><link rel="prefetch" href="/assets/js/53.e629d1be.js"><link rel="prefetch" href="/assets/js/54.cd4ccb97.js"><link rel="prefetch" href="/assets/js/55.ba74bcd9.js"><link rel="prefetch" href="/assets/js/56.ec779212.js"><link rel="prefetch" href="/assets/js/57.053d20a0.js"><link rel="prefetch" href="/assets/js/58.40e5b7c2.js"><link rel="prefetch" href="/assets/js/59.7c2ca6a0.js"><link rel="prefetch" href="/assets/js/6.e8274803.js"><link rel="prefetch" href="/assets/js/60.043bec3b.js"><link rel="prefetch" href="/assets/js/61.332f6d21.js"><link rel="prefetch" href="/assets/js/62.0119a09f.js"><link rel="prefetch" href="/assets/js/63.1c4ffaa5.js"><link rel="prefetch" href="/assets/js/64.61f885bf.js"><link rel="prefetch" href="/assets/js/65.a00bdf79.js"><link rel="prefetch" href="/assets/js/66.4f3bc0ca.js"><link rel="prefetch" href="/assets/js/67.5673aa98.js"><link rel="prefetch" href="/assets/js/68.9f871a79.js"><link rel="prefetch" href="/assets/js/69.1081a8b7.js"><link rel="prefetch" href="/assets/js/70.d4c980e2.js"><link rel="prefetch" href="/assets/js/71.be1daf85.js"><link rel="prefetch" href="/assets/js/72.b306842f.js"><link rel="prefetch" href="/assets/js/73.65c8494f.js"><link rel="prefetch" href="/assets/js/74.c3c2262b.js"><link rel="prefetch" href="/assets/js/75.70ab37cf.js"><link rel="prefetch" href="/assets/js/76.3af4cac5.js"><link rel="prefetch" href="/assets/js/77.b84ddacd.js"><link rel="prefetch" href="/assets/js/78.2236464f.js"><link rel="prefetch" href="/assets/js/8.42e8863a.js"><link rel="prefetch" href="/assets/js/9.1b471913.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.235cd43c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0a795576.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="taolin"><header class="tl-header"><div class="wrap"><div class="tl-logo"><h1><a href="/" class="router-link-active"><svg width="360" height="360" viewBox="0 0 360 360" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><rect width="360" height="360" fill="black"></rect> <path d="M314 217.328C314 222.203 312.453 228.719 309.359 236.875C301.391 258.25 286.109 274.703 263.516 286.234C243.734 296.359 221.469 301.422 196.719 301.422C163.25 301.422 137.984 292.516 120.922 274.703C105.453 258.578 97.7188 236.5 97.7188 208.469C97.7188 186.062 103.016 162.484 113.609 137.734C121.016 120.672 128.562 107.266 136.25 97.5156C109.438 100.516 85.4375 110.406 64.25 127.188C63.125 128.406 62.375 128.312 62 126.906C60.0312 114.344 57.4531 93.9062 54.2656 65.5938C54.3594 65.0312 54.9219 64.5625 55.9531 64.1875C130.203 70.4688 207.5 73.6094 287.844 73.6094C289.438 73.6094 290 74.5938 289.531 76.5625C279.688 115.281 273.641 146.266 271.391 169.516C264.641 168.484 255.922 166.75 245.234 164.312C240.172 162.625 237.641 160.047 237.641 156.578C237.641 154.703 238.344 150.531 239.75 144.062C241.25 137.5 242 132.625 242 129.438C242 124.844 240.547 121.609 237.641 119.734C220.859 108.672 207.547 102.438 197.703 101.031C180.734 133 172.25 168.391 172.25 207.203C172.25 228.766 175.484 246.484 181.953 260.359C188.891 275.453 198.453 283 210.641 283C219.734 283 229.719 279.391 240.594 272.172C250.719 265.328 255.781 259.797 255.781 255.578C255.781 253.891 255.219 253.047 254.094 253.047C239.938 250.891 227.797 246.25 217.672 239.125C205.672 230.781 199.672 220.656 199.672 208.75C199.672 202.375 203.891 197.125 212.328 193C220.859 188.875 232.391 186.812 246.922 186.812C253.391 186.812 260.984 187.375 269.703 188.5C299.234 192.438 314 202.047 314 217.328Z" fill="white"></path></g> <defs><clipPath id="clip0"><rect width="360" height="360" fill="white"></rect></clipPath></defs></svg></a></h1> <span>Taoya</span></div> <nav class="tl-menu"><ul class="tl-menu-list"><li class="tl-menu-item"><a href="/blog/"><span>技术</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li><li class="tl-menu-item"><a href="/about/"><span>关于</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li><li class="tl-menu-item"><a href="/life/"><span>记录</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li></ul> <div class="tl-menu-trigger"><button class="menu-btn"><svg viewBox="0 0 64 48"><path d="M19,15 L45,15 C70,15 58,-2 49.0177126,7 L19,37"></path> <path d="M19,24 L45,24 C61.2371586,24 57,49 41,33 L32,24"></path> <path d="M45,33 L19,33 C-8,33 6,-2 22,14 L45,37"></path></svg></button></div> <div class="tl-hamburger"><div class="menu-secondary-background-color"></div> <div class="tl-menu-overlay"><div class="tl-f-nav-list"><div class="menu-background"></div> <div class="container"><div class="tl-f-nav-col"><h3 class="tl-f-nav-item"><a href="/blog"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       01
                                   </div> <div class="tl-menu-name">
                                       技术
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/about"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       02
                                   </div> <div class="tl-menu-name">
                                       关于
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/life"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       03
                                   </div> <div class="tl-menu-name">
                                       生活记录
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3></div></div></div></div></div></nav></div></header> <div id="article-post" data-scroll=""><main class="container"><div class="back"><div class="icon-wrap"><svg aria-hidden="true" class="icon"><use xlink:href="#icon-fanhui"></use></svg></div></div> <header><h1 class="title">DRF自定义JWT身份验证</h1> <div class="time"><span class="month">05</span> <span>/ <span>15</span></span></div></header> <article class="tl-article-container"><!----> <div class="content__default"><p>Django Rest Framework（DRF）带有不同的内置身份验证类，令牌身份验证或JWT</p> <p><strong>技术栈</strong></p> <ul><li>Django</li> <li>Django Rest Framework</li></ul> <hr> <p><strong>步骤</strong></p> <p>用户发送带有用户名和密码的POST请求进行登录，然后服务器将执行3件事</p> <ul><li>生成一个<code>access_token</code>寿命很短的jwt（可能5分钟）并将其发送到响应正文中</li> <li>生成一个<code>refresh_token</code>寿命很长的jwt（天）并将其发送到httponly cookie中，因此无法从客户端javascript访问</li> <li>发送包含CSRF令牌的普通Cookie</li></ul> <p>开发人员需要确保所有不安全的视图（POST，UPDATE，PUT，Delete）均受内置的Django CSRF保护，因为如上所述，DRF默认禁用它们</p> <p>在客户端，开发人员应注意</p> <ul><li><p>在客户端，每个请求都将在cookie中自动包含刷新令牌（确保在服务器cors标头设置中将您的客户端域列入白名单）</p></li> <li><p><u>发送<code>access_token</code>中的<code>Authorization</code>标头</u></p></li> <li><p><code>X-CSRFTOKEN</code>如果他正在执行POST请求，请在标头中发送CSRF令牌</p></li> <li><p>当他需要一个新的时<code>access_token</code>，他需要发送一个POST请求来刷新令牌端点</p></li></ul> <hr> <blockquote><p>准备工作创建虚拟环境</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code>python <span class="token operator">-</span>m venv venv
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>pip install django
pip install django<span class="token operator">-</span>cors<span class="token operator">-</span>headers <span class="token comment"># 跨域</span>
pip install djangorestframework 
pip install pyjwt
pip install django<span class="token operator">-</span>simpleui <span class="token comment"># 后台UI框架 选用</span>
</code></pre></div><h3 id="项目设置"><a href="#项目设置" class="header-anchor"></a> 项目设置</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 创建一个Django项目</span>
django-admin startapp project

<span class="token comment"># 创建一个App</span>
python manage.py startapp accounts
</code></pre></div><p>在项目设置中启用应用程序并添加一些设置</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Settings.py</span>
INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment"># 插件</span>
    <span class="token string">'corsheaders'</span><span class="token punctuation">,</span>
    <span class="token string">'rest_framework'</span><span class="token punctuation">,</span>

    <span class="token comment">#Apps</span>
    <span class="token string">'accounts'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

CORS_ALLOW_CREDENTIALS <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># 通过ajax请求接受cookie</span>

REST_FRAMEWORK <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'DEFAULT_PERMISSION_CLASSES'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>
        <span class="token string">'rest_framework.permissions.IsAuthenticated'</span><span class="token punctuation">,</span> <span class="token comment"># 使所有端口私有</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建后台用户"><a href="#创建后台用户" class="header-anchor"></a> 创建后台用户</h3> <p>为Django身份验证中预定义的User模型编写API，因此我们无需定义新模型，而是可以继续描述序列化程序</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># (accounts)models.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models

<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>models <span class="token keyword">import</span> AbstractUser

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>AbstractUser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
</code></pre></div><p>然后在后台指定用户模型</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
AUTH_USER_MODEL <span class="token operator">=</span> <span class="token string">'accounts.User'</span> <span class="token comment"># accounts这个下的User模型</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
</code></pre></div><p>稍后您可以通过以下任一方式来引用用户模型</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings
User <span class="token operator">=</span> settings<span class="token punctuation">.</span>AUTH_USER_MODEL

<span class="token comment"># 或者</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> get_user_model
User <span class="token operator">=</span> get_user_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>并将<code>accounts.admin</code>新的用户模型注册到管理站点</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># (accounts)admin.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>admin <span class="token keyword">import</span> UserAdmin
<span class="token keyword">from</span> accounts<span class="token punctuation">.</span>models <span class="token keyword">import</span> User

admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>User<span class="token punctuation">,</span> UserAdmin<span class="token punctuation">)</span>
</code></pre></div><p>创建超级用户</p> <div class="language-shell extra-class"><pre class="language-shell"><code>makemigrations <span class="token comment"># 生成迁移模型</span>

migrate

createsuperuser <span class="token comment"># 创建用户</span>
</code></pre></div><p>最后是要测试的端点，正如我们在上述设置中声明的那样，默认情况下，所有端点都将需要身份验证，我们可以在某些视图中覆盖此身份，稍后我们将在登录时进行此操作</p> <hr> <blockquote><p>我们将创建用户配置文件端点，该端点将以JSON返回当前经过身份验证的用户对象，为此，我们需要创建用户序列化程序</p></blockquote> <p>创建用户序列化程序</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> serializers
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> User <span class="token comment"># 导入模型</span>

<span class="token keyword">class</span> <span class="token class-name">UserSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> User
        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">,</span> <span class="token string">'first_name'</span><span class="token punctuation">,</span> <span class="token string">'last_name'</span><span class="token punctuation">,</span> <span class="token string">'is_active'</span><span class="token punctuation">]</span>
        <span class="token comment"># 或者排除掉密码</span>
        <span class="token comment"># exclude = ['password']</span>
</code></pre></div><p><code>urls.py</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 根目录/urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'accounts/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'accounts.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 引入App/accounts</span>
<span class="token punctuation">]</span>


<span class="token comment"># APP(accounts).url</span>
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'profile'</span><span class="token punctuation">,</span> profile<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'profile'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><p><code>views.py</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> api_view
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">from</span> <span class="token punctuation">.</span>serializers <span class="token keyword">import</span> UserSerializer <span class="token comment"># 导入序列化</span>


<span class="token triple-quoted-string string">'''
	获取用户信息视图
'''</span>
<span class="token decorator annotation punctuation">@api_view</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">profile</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> request<span class="token punctuation">.</span>user
    serialized_user <span class="token operator">=</span> UserSerializer<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>data
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">:</span> serialized_user <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>现在，如果您尝试访问此端点，则会收到403错误，如简介中所述.</p> <p>我们需要登录，然后在请求标头中发送access_token</p> <p><img src="http://alicdn.itaolaity.com/img/20200515115433.png" alt=""></p> <h3 id="登录视图"><a href="#登录视图" class="header-anchor"></a> 登录视图</h3> <p>登录端将是带有<code>username</code>和<code>password</code>在请求正文中的发布请求。</p> <p>我们将使用权限类装饰器将登录视图公开<code>AllowAny</code>，并且<code>@ensure_csrf_cookie</code>如果登录成功，将强制Django在响应中发送CSRF cookie来装饰视图</p> <p>如果登录成功，我们将有</p> <ul><li>一个<code>access_token</code>在响应体中</li> <li>一个<code>refreshtoken</code>在的HttpOnly的cookie</li> <li>一个<code>csrftoken</code>在正常的cookie，所以我们可以从JavaScript阅读并在需要时重新发送</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>views <span class="token keyword">import</span>  APIView
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response
<span class="token keyword">from</span> <span class="token punctuation">.</span>serializers <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> get_user_model
<span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> exceptions
<span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>permissions <span class="token keyword">import</span> AllowAny
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>csrf <span class="token keyword">import</span>  ensure_csrf_cookie
<span class="token keyword">from</span> <span class="token punctuation">.</span>utils <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> <span class="token punctuation">.</span>authentications <span class="token keyword">import</span> JWTAuthentication


<span class="token triple-quoted-string string">'''
	获取用户信息
'''</span>
<span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span>JWTAuthentication<span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        user <span class="token operator">=</span> request<span class="token punctuation">.</span>user
        serialized_user <span class="token operator">=</span> UserSerializer<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>data
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'user'</span><span class="token punctuation">:</span> serialized_user<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
	登录视图
'''</span>
<span class="token keyword">class</span> <span class="token class-name">Login</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    permission_classes <span class="token operator">=</span> <span class="token punctuation">[</span>AllowAny<span class="token punctuation">]</span>
    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span>JWTAuthentication<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'login.html'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        User <span class="token operator">=</span> get_user_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
        username <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
        password <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>

        response <span class="token operator">=</span> Response<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>password <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span><span class="token string">'用户名或密码为空'</span><span class="token punctuation">)</span>

        user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span><span class="token string">'用户未找到'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> user<span class="token punctuation">.</span>check_password<span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span><span class="token string">'密码错误'</span><span class="token punctuation">)</span>

        serialized_user <span class="token operator">=</span> UserSerializer<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>data

        access_token <span class="token operator">=</span> generate_access_token<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        refresh_token <span class="token operator">=</span> generate_refresh_token<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>refresh_token<span class="token punctuation">)</span>

        response<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token string">'refreshtoken'</span><span class="token punctuation">,</span> value<span class="token operator">=</span>refresh_token<span class="token punctuation">,</span> httponly<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        response<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'access_token'</span><span class="token punctuation">:</span> access_token<span class="token punctuation">,</span>
            <span class="token string">'user'</span><span class="token punctuation">:</span> serialized_user
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> response
</code></pre></div><blockquote><p>标记</p> <p>也可以用drf内置的获取用户名与密码。</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>authtoken<span class="token punctuation">.</span>serializers <span class="token keyword">import</span> AuthTokenSerializer

<span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    serializer <span class="token operator">=</span> AuthTokenSerializer<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment"># 序列化</span>
    <span class="token keyword">if</span> serializer<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        user <span class="token operator">=</span> serializer<span class="token punctuation">.</span>validated_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
        user<span class="token punctuation">.</span>last_login <span class="token operator">=</span> now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 记录用户最后登录时间6</span>
        user<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        token <span class="token operator">=</span> generate_jwt<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        user_serializer <span class="token operator">=</span> UserSerializer<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">:</span>token<span class="token punctuation">,</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">:</span>user_serializer<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这是生成令牌的函数</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> datetime
<span class="token keyword">import</span> jwt
<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings

<span class="token triple-quoted-string string">'''
	生成登录成功Token
'''</span>
<span class="token keyword">def</span> <span class="token function">generate_access_token</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">:</span>

    access_token_payload <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'user_id'</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        <span class="token string">'exp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> minutes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">#5分</span>
        <span class="token string">'iat'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    access_token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>access_token_payload<span class="token punctuation">,</span>
                              settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> access_token


<span class="token keyword">def</span> <span class="token function">generate_refresh_token</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">:</span>
    refresh_token_payload <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'user_id'</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        <span class="token string">'exp'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment"># 7天</span>
        <span class="token string">'iat'</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    refresh_token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>
        refresh_token_payload<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> refresh_token
</code></pre></div><p><img src="http://alicdn.itaolaity.com/img/20200515123949.png" alt=""></p> <p><img src="http://alicdn.itaolaity.com/img/20200515130309.png" alt=""></p> <hr> <h3 id="drf的自定义身份验证类"><a href="#drf的自定义身份验证类" class="header-anchor"></a> DRF的自定义身份验证类</h3> <p>Django Rest Framework使创建自定义身份验证方案变得容易，它在<a href="https://www.django-rest-framework.org/api-guide/authentication/#custom-authentication" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中进行了详细描述</p> <p>先看一下drf的源代码</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>authentication <span class="token keyword">import</span> TokenAuthentication<span class="token punctuation">,</span>
</code></pre></div><p><img src="http://alicdn.itaolaity.com/img/20200524012857.png" alt=""></p> <p>先复制下来然后稍加修改</p> <p>创建一个<code>authentications.py</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>authentication <span class="token keyword">import</span> BaseAuthentication<span class="token punctuation">,</span> TokenAuthentication<span class="token punctuation">,</span> get_authorization_header
<span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> exceptions
<span class="token keyword">import</span> jwt
<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> get_user_model

User <span class="token operator">=</span> get_user_model<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 1. 继承BaseAuthentication</span>
<span class="token keyword">class</span> <span class="token class-name">JWTAuthentication</span><span class="token punctuation">(</span>BaseAuthentication<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    自定义头
    Authorization: JWT 401f7ac837da42b97f613d789819ff93537bee6a
    '''</span>
    keyword <span class="token operator">=</span> <span class="token string">'JWT'</span>
    model <span class="token operator">=</span> <span class="token boolean">None</span>


    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 拿到jwt值</span>
        auth <span class="token operator">=</span> get_authorization_header<span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
        

        <span class="token keyword">if</span> <span class="token keyword">not</span> auth <span class="token keyword">or</span> auth<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> self<span class="token punctuation">.</span>keyword<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">'认证失败'</span>
            <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">'应该提供一个空格'</span>
            <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            jwt_token <span class="token operator">=</span> auth<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token comment"># 解码</span>
            jwt_info <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>jwt_token<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 提取用户ID 对应加密的user_id</span>
            user_id <span class="token operator">=</span> jwt_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>user_id<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                msg <span class="token operator">=</span> <span class="token string">'用户名不存在'</span>
                <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

        <span class="token keyword">except</span> jwt<span class="token punctuation">.</span>ExpiredSignatureError<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> <span class="token string">'Token 过期'</span>
            <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
</code></pre></div><p>创建该类后，然后再去<code>settings.py</code>中更改全局配置</p> <div class="language-python extra-class"><pre class="language-python"><code>REST_FRAMEWORK <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>
        <span class="token string">'accounts.authentications.JWTAuthentication'</span><span class="token punctuation">,</span><span class="token comment"># APP.文件名.类名</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'DEFAULT_PERMISSION_CLASSES'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>
        <span class="token string">'rest_framework.permissions.IsAuthenticated'</span><span class="token punctuation">,</span> <span class="token comment"># 使所有端口私有</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="http://alicdn.itaolaity.com/img/20200524014125.png" alt=""></p> <p>重新访问试试。 这次我们将设置<code>Authorization</code>标头</p> <h3 id="刷新令牌视图"><a href="#刷新令牌视图" class="header-anchor"></a> 刷新令牌视图</h3> <p>每当令牌过期或出于任何原因需要新令牌时，我们都需要<code>refresh_token</code>。</p> <p>该视图需要获得的许可，<code>AlloAny</code>，<code>access_token</code>但是它将受到其他2件事的保护</p> <ul><li><p><code>refresh_token</code>httoponly cookie中发送的有效信息</p></li> <li><p>CSRF令牌，因此我们确保如果满足两个条件，上述cookie不会受到损害，然后服务器将生成一个新的有效值<code>access_token</code>并将其发送回去</p></li></ul> <p>如果<code>refresh_token</code>无效或过期，则用户需要重新登录</p> <blockquote><p>还记得刚才登录时候保存的refreshtoken吗</p></blockquote> <p><img src="http://alicdn.itaolaity.com/img/20200524014700.png" alt=""></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> jwt
<span class="token keyword">class</span> <span class="token class-name">RefreshTokenView</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    permission_classes <span class="token operator">=</span> <span class="token punctuation">[</span>AllowAny<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
         To obtain a new access_token this view expects 2 important things:
        1. a cookie that contains a valid refresh_token
        2. a header 'X-CSRFTOKEN' with a valid csrf token, client app can get it from cookies &quot;csrftoken&quot;
        '''</span>
        User <span class="token operator">=</span> get_user_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
        refresh_token <span class="token operator">=</span> request<span class="token punctuation">.</span>COOKIES<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'refreshtoken'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> refresh_token <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span>  exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span><span class="token string">'没有提供身份验证凭据'</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>refresh_token<span class="token punctuation">,</span> settings<span class="token punctuation">.</span>SECRET_KEY<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> jwt<span class="token punctuation">.</span>ExpiredSignatureError<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span><span class="token string">'过期的刷新令牌，请重新登录'</span><span class="token punctuation">)</span>

        user <span class="token operator">=</span> User<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">=</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> exceptions<span class="token punctuation">.</span>AuthenticationFailed<span class="token punctuation">(</span><span class="token string">'用户未找到'</span><span class="token punctuation">)</span>

        access_token <span class="token operator">=</span> generate_access_token<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'access_token'</span><span class="token punctuation">:</span> access_token<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="参考"><a href="#参考" class="header-anchor"></a> 参考</h3> <p><a href="https://dev.to/a_atalla/django-rest-framework-custom-jwt-authentication-5n5" target="_blank" rel="noopener noreferrer">Site<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div></article> <div class="tl-article-toc"><div class="vuepress-toc-item vuepress-toc-h3 active"><a href="#项目设置">项目设置</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#创建后台用户">创建后台用户</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#登录视图">登录视图</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#drf的自定义身份验证类">DRF的自定义身份验证类</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#刷新令牌视图">刷新令牌视图</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#参考">参考</a></div></div></main></div></div><div class="global-ui"><!----><div class="reading-progress bottom" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div></div></div>
    <script src="/assets/js/app.40859fda.js" defer></script><script src="/assets/js/7.92b229fa.js" defer></script><script src="/assets/js/46.c22951a1.js" defer></script>
  </body>
</html>
