<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mitmproxy代理 | Taoya</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+TC|Open+Sans|Poppins|Source+Sans+Pro|Ubuntu&amp;display=swap">
    <script src="/parallax.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/gsap/3.2.6/gsap.min.js"></script>
    <meta name="description" content="多言数穷，不如守中">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.fbc29428.css" as="style"><link rel="preload" href="/assets/js/app.2934c869.js" as="script"><link rel="preload" href="/assets/js/7.96aa0c69.js" as="script"><link rel="preload" href="/assets/js/51.914d1a8e.js" as="script"><link rel="prefetch" href="/assets/js/1.d886842f.js"><link rel="prefetch" href="/assets/js/10.b4cbacd4.js"><link rel="prefetch" href="/assets/js/11.5a820701.js"><link rel="prefetch" href="/assets/js/12.5d3cae48.js"><link rel="prefetch" href="/assets/js/13.6d61fc90.js"><link rel="prefetch" href="/assets/js/14.54e547ee.js"><link rel="prefetch" href="/assets/js/15.4c18c262.js"><link rel="prefetch" href="/assets/js/16.df779644.js"><link rel="prefetch" href="/assets/js/17.51c1142c.js"><link rel="prefetch" href="/assets/js/18.c2ba6705.js"><link rel="prefetch" href="/assets/js/19.afccd4f0.js"><link rel="prefetch" href="/assets/js/2.258cf35c.js"><link rel="prefetch" href="/assets/js/20.9523cfa0.js"><link rel="prefetch" href="/assets/js/21.02d839bd.js"><link rel="prefetch" href="/assets/js/22.c1d1793f.js"><link rel="prefetch" href="/assets/js/23.7460123d.js"><link rel="prefetch" href="/assets/js/24.057d205c.js"><link rel="prefetch" href="/assets/js/25.ba1eca7d.js"><link rel="prefetch" href="/assets/js/26.d87b38f7.js"><link rel="prefetch" href="/assets/js/27.fe61ab21.js"><link rel="prefetch" href="/assets/js/28.affd45f0.js"><link rel="prefetch" href="/assets/js/29.093dd35e.js"><link rel="prefetch" href="/assets/js/30.f9351291.js"><link rel="prefetch" href="/assets/js/31.406ddb6b.js"><link rel="prefetch" href="/assets/js/32.41556839.js"><link rel="prefetch" href="/assets/js/33.8651953c.js"><link rel="prefetch" href="/assets/js/34.402eb21e.js"><link rel="prefetch" href="/assets/js/35.528b492d.js"><link rel="prefetch" href="/assets/js/36.b6516203.js"><link rel="prefetch" href="/assets/js/37.9d43c85f.js"><link rel="prefetch" href="/assets/js/38.5b159c2e.js"><link rel="prefetch" href="/assets/js/39.ae794843.js"><link rel="prefetch" href="/assets/js/40.a68a1004.js"><link rel="prefetch" href="/assets/js/41.417cd709.js"><link rel="prefetch" href="/assets/js/42.b3c814d1.js"><link rel="prefetch" href="/assets/js/43.70442cf7.js"><link rel="prefetch" href="/assets/js/44.b0216088.js"><link rel="prefetch" href="/assets/js/45.0ea716a8.js"><link rel="prefetch" href="/assets/js/46.9e85ca44.js"><link rel="prefetch" href="/assets/js/47.1e1a704a.js"><link rel="prefetch" href="/assets/js/48.44fe07a4.js"><link rel="prefetch" href="/assets/js/49.a1f05ac5.js"><link rel="prefetch" href="/assets/js/5.a5f98c38.js"><link rel="prefetch" href="/assets/js/50.b19afa89.js"><link rel="prefetch" href="/assets/js/52.b4ba59d1.js"><link rel="prefetch" href="/assets/js/53.94234cfe.js"><link rel="prefetch" href="/assets/js/54.3c8d7352.js"><link rel="prefetch" href="/assets/js/55.97703121.js"><link rel="prefetch" href="/assets/js/56.b097d1b9.js"><link rel="prefetch" href="/assets/js/57.dbe97c76.js"><link rel="prefetch" href="/assets/js/58.be101d03.js"><link rel="prefetch" href="/assets/js/59.2b707b42.js"><link rel="prefetch" href="/assets/js/6.54279ef5.js"><link rel="prefetch" href="/assets/js/60.8dc3ecd1.js"><link rel="prefetch" href="/assets/js/61.3abd3d2d.js"><link rel="prefetch" href="/assets/js/62.6efd2868.js"><link rel="prefetch" href="/assets/js/63.a0aa1079.js"><link rel="prefetch" href="/assets/js/64.0ed67c1f.js"><link rel="prefetch" href="/assets/js/65.62c07d05.js"><link rel="prefetch" href="/assets/js/66.c1d457b0.js"><link rel="prefetch" href="/assets/js/67.84445610.js"><link rel="prefetch" href="/assets/js/68.ef96b3be.js"><link rel="prefetch" href="/assets/js/69.5cbd049c.js"><link rel="prefetch" href="/assets/js/70.a83eed2c.js"><link rel="prefetch" href="/assets/js/71.d8caec13.js"><link rel="prefetch" href="/assets/js/72.74b9dc75.js"><link rel="prefetch" href="/assets/js/73.d8fb1905.js"><link rel="prefetch" href="/assets/js/74.c7872994.js"><link rel="prefetch" href="/assets/js/75.24e28d2a.js"><link rel="prefetch" href="/assets/js/76.22bcdf40.js"><link rel="prefetch" href="/assets/js/77.cdbbc4d9.js"><link rel="prefetch" href="/assets/js/78.fcb7b111.js"><link rel="prefetch" href="/assets/js/8.31b10017.js"><link rel="prefetch" href="/assets/js/9.24d6651a.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.eb9498ce.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fbc29428.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="taolin"><header class="tl-header"><div class="wrap"><div class="tl-logo"><h1><a href="/" class="router-link-active"><svg width="360" height="360" viewBox="0 0 360 360" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0)"><rect width="360" height="360" fill="black"></rect> <path d="M314 217.328C314 222.203 312.453 228.719 309.359 236.875C301.391 258.25 286.109 274.703 263.516 286.234C243.734 296.359 221.469 301.422 196.719 301.422C163.25 301.422 137.984 292.516 120.922 274.703C105.453 258.578 97.7188 236.5 97.7188 208.469C97.7188 186.062 103.016 162.484 113.609 137.734C121.016 120.672 128.562 107.266 136.25 97.5156C109.438 100.516 85.4375 110.406 64.25 127.188C63.125 128.406 62.375 128.312 62 126.906C60.0312 114.344 57.4531 93.9062 54.2656 65.5938C54.3594 65.0312 54.9219 64.5625 55.9531 64.1875C130.203 70.4688 207.5 73.6094 287.844 73.6094C289.438 73.6094 290 74.5938 289.531 76.5625C279.688 115.281 273.641 146.266 271.391 169.516C264.641 168.484 255.922 166.75 245.234 164.312C240.172 162.625 237.641 160.047 237.641 156.578C237.641 154.703 238.344 150.531 239.75 144.062C241.25 137.5 242 132.625 242 129.438C242 124.844 240.547 121.609 237.641 119.734C220.859 108.672 207.547 102.438 197.703 101.031C180.734 133 172.25 168.391 172.25 207.203C172.25 228.766 175.484 246.484 181.953 260.359C188.891 275.453 198.453 283 210.641 283C219.734 283 229.719 279.391 240.594 272.172C250.719 265.328 255.781 259.797 255.781 255.578C255.781 253.891 255.219 253.047 254.094 253.047C239.938 250.891 227.797 246.25 217.672 239.125C205.672 230.781 199.672 220.656 199.672 208.75C199.672 202.375 203.891 197.125 212.328 193C220.859 188.875 232.391 186.812 246.922 186.812C253.391 186.812 260.984 187.375 269.703 188.5C299.234 192.438 314 202.047 314 217.328Z" fill="white"></path></g> <defs><clipPath id="clip0"><rect width="360" height="360" fill="white"></rect></clipPath></defs></svg></a></h1> <span>Taoya</span></div> <nav class="tl-menu"><ul class="tl-menu-list"><li class="tl-menu-item"><a href="/blog/"><span>技术</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li><li class="tl-menu-item"><a href="/about/"><span>关于</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li><li class="tl-menu-item"><a href="/life/"><span>记录</span> <svg xmlns="http://www.w3.org/2000/svg" width="38" height="4" viewBox="0 0 53 4" fill="none"><g clip-path="url(#clip0)"><path d="M51.9 3C49 3 49 1 46.2 1c-2.8 0-2.8 2-5.7 2-2.8 0-2.8-2-5.7-2C32 1 32 3 29.1 3c-2.8 0-2.8-2-5.7-2-2.8 0-2.8 2-5.6 2S15 1 12.1 1C9.5 1 9.5 3 6.7 3 3.8 3 3.8 1 1 1" stroke="#404040" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0"><rect width="52.9" height="4" fill="#404040"></rect></clipPath></defs></svg></a></li></ul> <div class="tl-menu-trigger"><button class="menu-btn"><svg viewBox="0 0 64 48"><path d="M19,15 L45,15 C70,15 58,-2 49.0177126,7 L19,37"></path> <path d="M19,24 L45,24 C61.2371586,24 57,49 41,33 L32,24"></path> <path d="M45,33 L19,33 C-8,33 6,-2 22,14 L45,37"></path></svg></button></div> <div class="tl-hamburger"><div class="menu-secondary-background-color"></div> <div class="tl-menu-overlay"><div class="tl-f-nav-list"><div class="menu-background"></div> <div class="container"><div class="tl-f-nav-col"><h3 class="tl-f-nav-item"><a href="/blog"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       01
                                   </div> <div class="tl-menu-name">
                                       技术
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/about"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       02
                                   </div> <div class="tl-menu-name">
                                       关于
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3><h3 class="tl-f-nav-item"><a href="/life"><div class="inner"><div class="tl-menu-content"><div class="tl-menu-index">
                                       03
                                   </div> <div class="tl-menu-name">
                                       生活记录
                                   </div></div> <div class="tl-menu-icon"><div class="tl-menu-icon_typeSVG"><svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17"><g fill="none" fill-rule="evenodd" stroke="#000" stroke-linecap="round" stroke-linejoin="round" transform="rotate(-135 7.533 9.872)"><path d="M7.80044955,21.4512363 L7.81236952,0.231533347" style="stroke-dashoffset:0;stroke-dasharray:22.2197px, 32.2197px;"></path> <path d="M15.601 13.651 7.8 21.451 0 13.651" style="stroke-dashoffset:0;stroke-dasharray:none;"></path></g></svg></div></div> <div class="tl-menu-border"></div></div></a></h3></div></div></div></div></div></nav></div></header> <div id="article-post" data-scroll=""><main class="container"><div class="back"><div class="icon-wrap"><svg aria-hidden="true" class="icon"><use xlink:href="#icon-fanhui"></use></svg></div></div> <header><h1 class="title">Mitmproxy代理</h1> <div class="time"><span class="month">05</span> <span>/ <span>25</span></span></div></header> <article class="tl-article-container"><!----> <div class="content__default"><p><a href="https://www.mitmproxy.org/" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>mitmproxy 就是用于 MITM 的 proxy，MITM 即中间人攻击（Man-in-the-middle attack）。用于中间人攻击的代理首先会向正常的代理一样转发请求，保障服务端与客户端的通信，其次，会适时的查、记录其截获的数据，或篡改数据，引发服务端或客户端特定的行为。</p> <p><img src="http://cdn.itaolaity.com/20200219180211.png" alt=""></p> <p><strong>特点</strong></p> <ol><li><p>和正常的代理一样转发请求，保障服务端、客户端运行</p></li> <li><p>拦截请求、修改请求、拦截返回、修改返回</p></li> <li><p>载入自定义Python脚本</p></li></ol> <p><strong>三大组件</strong></p> <ul><li>mitmproxy</li> <li>mitmdump</li> <li>mitmweb</li></ul> <h3 id="安装"><a href="#安装" class="header-anchor"></a> 安装</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>$ mitmweb --version
Mitmproxy: <span class="token number">4.0</span>.4
Python:    <span class="token number">3.7</span>.3
OpenSSL:   OpenSSL <span class="token number">1.1</span>.0i  <span class="token number">14</span> Aug <span class="token number">2018</span>
Platform:  Windows-10-10.0.17763-SP0
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>$ mitmdump --version
Mitmproxy: <span class="token number">4.0</span>.4
Python:    <span class="token number">3.7</span>.3
OpenSSL:   OpenSSL <span class="token number">1.1</span>.0i  <span class="token number">14</span> Aug <span class="token number">2018</span>
Platform:  Windows-10-10.0.17763-SP0
</code></pre></div><h4 id="安装证书"><a href="#安装证书" class="header-anchor"></a> 安装证书</h4> <p>前提要启动服务</p> <div class="language-shelll extra-class"><pre class="language-text"><code>mitmproxy -p 8200 --set block_global=false
</code></pre></div><p>将浏览器切换代理8080端口</p> <p><code>http://mitm.it/</code></p> <p><img src="http://cdn.itaolaity.com/20200219152600.png" alt=""></p> <p>下载相关平台的新人证书然后导入，即可。</p> <h3 id="运行"><a href="#运行" class="header-anchor"></a> 运行</h3> <p>要启动 mitmproxy 用 <code>mitmproxy</code>、<code>mitmdump</code>、<code>mitmweb</code> 这三个命令中的任意一个即可，这三个命令功能一致，且都可以加载自定义脚本，唯一的区别是交互界面的不同。</p> <img src="http://alicdn.itaolaity.com/img/20200410223503.png"> <h2 id="命令"><a href="#命令" class="header-anchor"></a> 命令</h2> <div class="language-shell extra-class"><pre class="language-shell"><code>mitmproxy 
-p  // 设置监听端口号
--set <span class="token assign-left variable">block_global</span><span class="token operator">=</span>false // 公网环境需要设置否则失败连接
</code></pre></div><p>[hint  type=&quot;info&quot; title=“提示”]
<strong>mitmproxy</strong>是一个控制台工具  使用<code>?</code>快捷键从任何<strong>mitmproxy</strong>屏幕上查看帮助文档
[/hint]</p> <h2 id="过滤表达式f"><a href="#过滤表达式f" class="header-anchor"></a> 过滤表达式<code>f</code></h2> <p>[hint type=“info” title=“快捷键”]</p> <p>快捷键f</p> <p>[/hint]</p> <table><thead><tr><th style="text-align:left;">~a</th> <th>过滤返回来的资源比如 CSS, Javascript, Flash, images.</th></tr></thead> <tbody><tr><td style="text-align:left;">~b regex</td> <td>Body</td></tr> <tr><td style="text-align:left;">~bq regex</td> <td>Request body</td></tr> <tr><td style="text-align:left;">~bs regex</td> <td>Response body</td></tr> <tr><td style="text-align:left;">~c int</td> <td>HTTP response code</td></tr> <tr><td style="text-align:left;">~d regex</td> <td>域名正则</td></tr> <tr><td style="text-align:left;">~dst regex</td> <td>Match destination address</td></tr> <tr><td style="text-align:left;">~e</td> <td>Match error</td></tr> <tr><td style="text-align:left;">~h regex</td> <td>Header</td></tr> <tr><td style="text-align:left;">~hq regex</td> <td>Request header</td></tr> <tr><td style="text-align:left;">~hs regex</td> <td>Response header</td></tr> <tr><td style="text-align:left;">~http</td> <td>Match HTTP flows</td></tr> <tr><td style="text-align:left;">~m regex</td> <td>Method</td></tr> <tr><td style="text-align:left;">~marked</td> <td>Match marked flows</td></tr> <tr><td style="text-align:left;">~q</td> <td>Match request with no response</td></tr> <tr><td style="text-align:left;">~s</td> <td>Match response</td></tr> <tr><td style="text-align:left;">~src regex</td> <td>Match source address</td></tr> <tr><td style="text-align:left;">~t regex</td> <td>Content-type header</td></tr> <tr><td style="text-align:left;">~tcp</td> <td>Match TCP flows</td></tr> <tr><td style="text-align:left;">~tq regex</td> <td>Request Content-Type header</td></tr> <tr><td style="text-align:left;">~ts regex</td> <td>Response Content-Type header</td></tr> <tr><td style="text-align:left;">~u regex</td> <td>URL</td></tr> <tr><td style="text-align:left;">~websocket</td> <td>Match WebSocket flows</td></tr> <tr><td style="text-align:left;">!</td> <td>not</td></tr> <tr><td style="text-align:left;">&amp;</td> <td>and</td></tr> <tr><td style="text-align:left;">|</td> <td>or</td></tr> <tr><td style="text-align:left;">(...)</td> <td>grouping</td></tr></tbody></table> <p>[hint type=“info”  title=“提示”]</p> <ul><li>正则表达式是Python风格的</li></ul> <p>[/hint]</p> <h3 id="例子"><a href="#例子" class="header-anchor"></a> 例子</h3> <blockquote><p>过滤只有百度的域名</p></blockquote> <p>按<code>f</code> 然后输入过滤规则<code>~d baidu.com</code></p> <img src="http://alicdn.itaolaity.com/img/20200410233229.png"> <blockquote><p>过滤请求方法为Post且域名为包含baidu的数据流</p></blockquote> <p><code>~d baidu.com % ~m post</code></p> <img src="http://alicdn.itaolaity.com/img/20200410233518.png"> <h2 id="断点拦截i"><a href="#断点拦截i" class="header-anchor"></a> 断点拦截<code>i</code></h2> <p>[hint type=“info”  title=“快捷键”]</p> <p>快捷键i</p> <p>[/hint]</p> <blockquote><p>请求拦截</p></blockquote> <p>比如想要拦截<code>itaolaity.com</code> 的数据</p> <img src="http://alicdn.itaolaity.com/img/20200410234024.png"> <p>然后停留到这里来了，且时间为红色标记</p> <img src="http://alicdn.itaolaity.com/img/20200410234207.png"> <p>按下回车查看详细信息。且按下<code>e</code></p> <img src="http://alicdn.itaolaity.com/img/20200410234436.png"> <p>选择要修改的参数</p> <div class="language-shell extra-class"><pre class="language-shell"><code>比如
cookies
url
<span class="token punctuation">..</span>.
</code></pre></div><p>最后返回界面按下<code>a</code> 继续往下走。</p> <h2 id="脚本-mitmdump"><a href="#脚本-mitmdump" class="header-anchor"></a> 脚本 - mitmdump</h2> <p>编写一个py文件提供给mitmproxy加载。</p> <p>文件中定义了若干函数，这些函数实现了某些 mitmproxy 提供的事件，mitmproxy 会在某个事件发生时调用对应的函数</p> <p>或者 编写一个 py 文件供 mitmproxy 加载，文件定义了变量 addons，addons 是个数组，每个元素是一个类实例，这些类有若干方法，这些方法实现了某些 mitmproxy 提供的事件，mitmproxy 会在某个事件发生时调用对应的方法。这些类，称为一个个 <code>addon</code>，比如一个叫 Counter 的 addon</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> mitmproxy<span class="token punctuation">.</span>http
<span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx


<span class="token keyword">class</span> <span class="token class-name">Counter</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>num <span class="token operator">=</span> self<span class="token punctuation">.</span>num <span class="token operator">+</span> <span class="token number">1</span>
        ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;We've seen %d flows&quot;</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>num<span class="token punctuation">)</span>


addons <span class="token operator">=</span> <span class="token punctuation">[</span>
    Counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><p><strong>启动</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>mitmdump -p <span class="token number">8080</span>
</code></pre></div><blockquote><p>编写一个py脚本用来供mitmproxy加载。</p> <p>实现mitmproxy提供的事件，mitmproxy会在某个事件发生调用相关函数。</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>mitmdump 
-p 指定端口号
-s 指定py脚本
-w 指定写入文件 默认将所有流量写入outfile
</code></pre></div><blockquote><p>测试</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> mitmproxy<span class="token punctuation">.</span>http <span class="token comment"># http处理模块</span>
<span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx <span class="token comment"># 日志模块</span>

<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;URL: \t&quot;</span><span class="token operator">+</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 请求头</span>
    ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>  
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>λ mitmdump -p <span class="token number">8080</span> -s main.py
Loading script main.py <span class="token comment"># 加载脚本</span>
Proxy server listening at http://*:8080 <span class="token comment">#监听端口</span>

<span class="token number">127.0</span>.0.1:14072: clientconnect
URL:    https://sug.so.360.cn/suggest?encodein<span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">encodeout</span><span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">format</span><span class="token operator">=</span>opensearch<span class="token operator">&amp;</span><span class="token assign-left variable">word</span><span class="token operator">=</span>
Headers<span class="token punctuation">[</span><span class="token punctuation">(</span>b<span class="token string">'Host'</span>, b<span class="token string">'sug.so.360.cn'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Connection'</span>, b<span class="token string">'keep-alive'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Sec-Fetch-Site'</span>, b<span class="token string">'none'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Sec-Fetch-Mode'</span>, b<span class="token string">'no-cors'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'User-Agent'</span>, b<span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.117 Safari/537.36'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Accept-Encoding'</span>, b<span class="token string">'gzip, deflate, br'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Accept-Language'</span>, b<span class="token string">'zh,zh-CN;q=0.9,en;q=0.8'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Cookie'</span>, b<span class="token string">'__huid=110y7q8GOJVD4AeHprC/qVgeaKmeZo0r/0O1mg48NrWBQ=; __guid=209084363.1328179603006700032.1557537740001.3984; __gid=156009789.758223608.1572875073297.1572875076825.4; __DC_gid=156009789.758223608.1572875073297.1573629455750.9'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
/suggest?encodein<span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">encodeout</span><span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">format</span><span class="token operator">=</span>opensearch<span class="token operator">&amp;</span><span class="token assign-left variable">word</span><span class="token operator">=</span>

<span class="token number">127.0</span>.0.1:14072: GET https://sug.so.360.cn/suggest?encodein<span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">encodeout</span><span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">format</span><span class="token operator">=</span>opensearch<span class="token operator">&amp;</span><span class="token assign-left variable">word</span><span class="token operator">=</span>
              <span class="token operator">&lt;&lt;</span> <span class="token number">200</span> OK 7b
URL:    https://sug.so.360.cn/suggest?encodein<span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">encodeout</span><span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">format</span><span class="token operator">=</span>opensearch<span class="token operator">&amp;</span><span class="token assign-left variable">word</span><span class="token operator">=</span>i
Headers<span class="token punctuation">[</span><span class="token punctuation">(</span>b<span class="token string">'Host'</span>, b<span class="token string">'sug.so.360.cn'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Connection'</span>, b<span class="token string">'keep-alive'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Sec-Fetch-Site'</span>, b<span class="token string">'none'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Sec-Fetch-Mode'</span>, b<span class="token string">'no-cors'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'User-Agent'</span>, b<span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.117 Safari/537.36'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Accept-Encoding'</span>, b<span class="token string">'gzip, deflate, br'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Accept-Language'</span>, b<span class="token string">'zh,zh-CN;q=0.9,en;q=0.8'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Cookie'</span>, b<span class="token string">'__huid=110y7q8GOJVD4AeHprC/qVgeaKmeZo0r/0O1mg48NrWBQ=; __guid=209084363.1328179603006700032.1557537740001.3984; __gid=156009789.758223608.1572875073297.1572875076825.4; __DC_gid=156009789.758223608.1572875073297.1573629455750.9'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
/suggest?encodein<span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">encodeout</span><span class="token operator">=</span>UTF-8<span class="token operator">&amp;</span><span class="token assign-left variable">format</span><span class="token operator">=</span>opensearch<span class="token operator">&amp;</span><span class="token assign-left variable">word</span><span class="token operator">=</span>i
</code></pre></div><p>定义了一个request()方法。参数为flow，它其实是一个HTTPFlow对象。通过request属性即可获取到当前请求对象。</p> <h4 id="日志输出"><a href="#日志输出" class="header-anchor"></a> 日志输出</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>from mitmproxy <span class="token function">import</span> ctx
</code></pre></div><p>可以设定不同级别的不同颜色的结果</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ctx.log.info<span class="token punctuation">(</span><span class="token punctuation">)</span> // 白色
     <span class="token punctuation">..</span>.warn<span class="token punctuation">(</span><span class="token punctuation">)</span> // 黄色
     <span class="token punctuation">..</span>.error<span class="token punctuation">(</span><span class="token punctuation">)</span>// 红色
</code></pre></div><p>调用ctx模块</p> <h4 id="request对象"><a href="#request对象" class="header-anchor"></a> Request对象</h4> <p>Request对象什么功能呢？</p> <blockquote><p>例子 - 常用属性</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> mitmproxy<span class="token punctuation">.</span>http
<span class="token keyword">from</span> mitmproxy <span class="token keyword">import</span> ctx <span class="token comment"># 日志模块</span>

<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    info <span class="token operator">=</span> ctx<span class="token punctuation">.</span>log<span class="token punctuation">.</span>info
    request <span class="token operator">=</span> flow<span class="token punctuation">.</span>request
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;\n\n+++++++++++++++++  开始  ++++++++++++++++++++++&quot;</span><span class="token punctuation">)</span>
    info<span class="token punctuation">(</span><span class="token string">&quot;URL: \t&quot;</span><span class="token operator">+</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    info<span class="token punctuation">(</span><span class="token string">&quot;Headers: \t&quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
    info<span class="token punctuation">(</span><span class="token string">&quot;Cookies: \t&quot;</span><span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">)</span>
    info<span class="token punctuation">(</span><span class="token string">&quot;Method: \t&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>method<span class="token punctuation">)</span>
    info<span class="token punctuation">(</span><span class="token string">&quot;Port: \t&quot;</span><span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    info<span class="token punctuation">(</span><span class="token string">&quot;Scheme: \t&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>scheme<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;+++++++++++++++++++++++++++++++++++++++\n\n&quot;</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>URL: https://blog.itaolaity.com/usr/plugins/Mirages/biaoqing/paopao/E5A4A7E68B87E68C87_2x.png                                                          
Headers: Headers<span class="token punctuation">[</span><span class="token punctuation">(</span>b<span class="token string">'Host'</span>, b<span class="token string">'blog.itaolaity.com'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>b<span class="token string">'Connection'</span>, b<span class="token string">'keep-alive'</span><span class="token punctuation">)</span>
Cookies: MultiDictView<span class="token punctuation">[</span><span class="token punctuation">[</span>'crisp-client%2Fsession%2F1e699570-3cf8-4358-a<span class="token punctuation">..</span>.                                                                                                               
Method: GET                                                                                                                                       
Port: <span class="token number">443</span>                                                                                                                                               
Scheme: https                                                                                                                                  
</code></pre></div><hr> <blockquote><p>伪造站点</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> mitmproxy<span class="token punctuation">.</span>http

<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'https://blog.itaolaity.com/'</span>
    <span class="token keyword">if</span> <span class="token string">'itaolaity.com'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">:</span>
        flow<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url <span class="token operator">=</span> url

</code></pre></div><p><img src="http://cdn.itaolaity.com/20200219175044.png" alt=""></p> <p>可以看到无论访问什么网站，都会访问指定url但是上面的域名还是要访问的。</p> <h4 id="response对象"><a href="#response对象" class="header-anchor"></a> Response对象</h4> <p>响应内容，Response Body才是爬取的结果。</p> <blockquote><p>测试</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> mitmproxy<span class="token punctuation">.</span>http

<span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>flow<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> flow<span class="token punctuation">.</span>response
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;响应内容： \t&quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre></div><h2 id="事件"><a href="#事件" class="header-anchor"></a> 事件</h2> <p>事件针对不同生命周期分为 5 类 。</p> <p>同样是一次 web 请求，我可以理解为“HTTP 请求 -&gt; HTTP 响应”的过程，也可以理解为“TCP 连接 -&gt; TCP 通信 -&gt; TCP 断开”的过程。那么，如果我想拒绝来个某个 IP 的客户端请求，应当注册函数到针对 TCP 生命周期 的 <code>tcp_start</code> 事件，又或者，我想阻断对某个特定域名的请求时，则应当注册函数到针对 HTTP 声明周期的 <code>http_connect</code> 事件</p> <h3 id="http周期"><a href="#http周期" class="header-anchor"></a> http周期</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">http_connect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><p>(Called when) 收到了来自客户端的 HTTP CONNECT 请求。在 flow 上设置非 2xx 响应将返回该响应并断开连接。CONNECT 不是常用的 HTTP 请求方法，目的是与服务器建立代理连接，仅是 client 与 proxy 的之间的交流，所以 CONNECT 请求不会触发 request、response 等其他常规的 HTTP 事件。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">requestheaders</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><p>(Called when) 来自客户端的 HTTP 请求的头部被成功读取。此时 flow 中的 request 的 body 是空的</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><p>(Called when) 来自服务端端的 HTTP 响应被成功完整读取</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">error</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><p>(Called when) 发生了一个 HTTP 错误。比如无效的服务端响应、连接断开等。注意与“有效的 HTTP 错误返回”不是一回事，后者是一个正确的服务端响应，只是 HTTP code 表示错误而已</p> <h3 id="tcp周期"><a href="#tcp周期" class="header-anchor"></a> tcp周期</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 建立了一个 TCP 连接</span>
<span class="token keyword">def</span> <span class="token function">tcp_start</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>tcp<span class="token punctuation">.</span>TCPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># TCP 连接收到了一条消息</span>
<span class="token keyword">def</span> <span class="token function">tcp_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>tcp<span class="token punctuation">.</span>TCPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 发生了 TCP 错误</span>
<span class="token keyword">def</span> <span class="token function">tcp_error</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>tcp<span class="token punctuation">.</span>TCPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#  TCP 连接关闭</span>
<span class="token keyword">def</span> <span class="token function">tcp_end</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>tcp<span class="token punctuation">.</span>TCPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><h3 id="websocket-生命周期"><a href="#websocket-生命周期" class="header-anchor"></a> Websocket 生命周期</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">websocket_handshake</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HTTPFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">websocket_start</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>WebSocketFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">websocket_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>WebSocketFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">websocket_error</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>WebSocketFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">websocket_end</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> flow<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>WebSocketFlow<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><h3 id="网络连接生命周期"><a href="#网络连接生命周期" class="header-anchor"></a> 网络连接生命周期</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 	客户端连接到了 mitmproxy。注意一条连接可能对应多个 HTTP 请求</span>
<span class="token keyword">def</span> <span class="token function">clientconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> layer<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 客户端断开了和 mitmproxy 的连接</span>
<span class="token keyword">def</span> <span class="token function">clientdisconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> layer<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">serverconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conn<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>connections<span class="token punctuation">.</span>ServerConnection<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">serverdisconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conn<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>connections<span class="token punctuation">.</span>ServerConnection<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">next_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> layer<span class="token punctuation">:</span> mitmproxy<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>protocol<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor"></a> 参考</h2> <ul><li>官方文档</li></ul> <p>https://docs.mitmproxy.org/stable/concepts-filters/</p> <ul><li>官网</li></ul> <p>https://www.mitmproxy.org/</p> <ul><li>博客</li></ul> <p>https://www.cnblogs.com/grandlulu/p/9525417.html</p> <p>https://blog.wolfogre.com/</p></div></article> <div class="tl-article-toc"><div class="vuepress-toc-item vuepress-toc-h3 active"><a href="#安装">安装</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#运行">运行</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#命令">命令</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#过滤表达式f">过滤表达式f</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#例子">例子</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#断点拦截i">断点拦截i</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#脚本-mitmdump">脚本 - mitmdump</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#事件">事件</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#http周期">http周期</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#tcp周期">tcp周期</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#websocket-生命周期">Websocket 生命周期</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#网络连接生命周期">网络连接生命周期</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#参考">参考</a></div></div></main></div></div><div class="global-ui"><div class="reading-progress bottom" data-v-21b39eda><div class="progress" data-v-21b39eda></div></div></div></div>
    <script src="/assets/js/app.2934c869.js" defer></script><script src="/assets/js/7.96aa0c69.js" defer></script><script src="/assets/js/51.914d1a8e.js" defer></script>
  </body>
</html>
